@page "/Admin/AuditLogs"
@model Apartment.Pages.Admin.AuditLogsModel
@{
    ViewData["Title"] = "System Audit Logs";
    Layout = "_Layout";
}

<div class="d-flex matcha-shell">
    @await Html.PartialAsync("_AdminSidebar")

    <!-- Main Content -->
    <div class="main-content audit-main">
        <div class="container-fluid audit-container">
            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-0 shadow-sm audit-header">
                        <div class="card-body d-flex justify-content-between align-items-start flex-wrap gap-3">
                            <div>
                                <h1 class="audit-title mb-1">
                                    <i class="bi bi-clipboard-data me-2"></i>System Audit Logs
                                </h1>
                                <p class="audit-subtitle mb-0">
                                    A chronological trail of important events across the system.
                                </p>
                            </div>
                            <form method="post" class="d-flex flex-wrap gap-2">
                                <button type="submit"
                                        asp-page-handler="ExportExcel"
                                        class="btn btn-matcha-outline"
                                        data-file-download="true">
                                    <i class="bi bi-file-earmark-spreadsheet me-1"></i>
                                    Export to Excel
                                </button>
                                <button type="submit"
                                        asp-page-handler="ExportPdf"
                                        class="btn btn-azuki-outline"
                                        data-file-download="true">
                                    <i class="bi bi-filetype-pdf me-1"></i>
                                    Export to PDF
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Filters & Quick Search -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-0 shadow-sm audit-filter-card">
                        <div class="card-body p-3 p-lg-4">
                            <div class="row g-3 align-items-end">
                                <div class="col-md-5">
                                    <label class="form-label small text-muted mb-1">Search activity</label>
                                    <div class="input-group audit-search-input">
                                        <span class="input-group-text bg-white border-end-0">
                                            <i class="bi bi-search text-muted"></i>
                                        </span>
                                        <input type="text"
                                               id="auditSearch"
                                               class="form-control border-start-0"
                                               placeholder="Search by user, action, details, or IP..." />
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small text-muted mb-1">Status</label>
                                    <select id="auditStatusFilter" class="form-select audit-select">
                                        <option value="">All</option>
                                        <option value="Success">Success</option>
                                        <option value="Failure">Failure</option>
                                    </select>
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label small text-muted mb-1">Quick insight</label>
                                    <div class="audit-helper small">
                                        <span class="audit-dot-success me-1"></span> Successful actions
                                        <span class="mx-2">Â·</span>
                                        <span class="audit-dot-failure me-1"></span> Failed or blocked attempts
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Audit Logs Table -->
            <div class="row">
                <div class="col-12">
                    <div class="card border-0 shadow-sm audit-table-card">
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover mb-0 data-table audit-table" id="auditLogsTable">
                                    <thead class="audit-table-head">
                                        <tr>
                                            <th class="border-0 audit-th">Timestamp</th>
                                            <th class="border-0 audit-th">User</th>
                                            <th class="border-0 audit-th">Action</th>
                                            <th class="border-0 audit-th">Details</th>
                                            <th class="border-0 audit-th">IP Address</th>
                                            <th class="border-0 audit-th text-center">Status</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @if (Model.AuditLogs != null && Model.AuditLogs.Any())
                                        {
                                            foreach (var log in Model.AuditLogs)
                                            {
                                                <tr>
                                                    <td class="align-middle audit-mono">
                                                        @log.Timestamp.ToString("yyyy-MM-dd HH:mm:ss")
                                                    </td>
                                                    <td class="align-middle">
                                                        <span class="fw-semibold">@(log.User?.Username ?? "System")</span>
                                                    </td>
                                                    <td class="align-middle">
                                                        <span class="audit-action">@log.Action</span>
                                                    </td>
                                                    <td class="align-middle">
                                                        <span class="audit-details text-muted" title="@log.Details">
                                                            @log.Details
                                                        </span>
                                                    </td>
                                                    <td class="align-middle">
                                                        <span class="audit-ip audit-mono">@log.IpAddress</span>
                                                    </td>
                                                    <td class="align-middle text-center">
                                                        @if (log.Success)
                                                        {
                                                            <span class="badge audit-badge-success">Success</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge audit-badge-failure">Failure</span>
                                                        }
                                                    </td>
                                                </tr>
                                            }
                                        }
                                        else
                                        {
                                            <tr>
                                                <td colspan="6" class="text-center py-4">
                                                    <div class="text-muted">
                                                        No audit activity has been recorded yet.
                                                    </div>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .matcha-shell {
        background: #F9F8F3;
    }

    .audit-main {
        margin-left: 280px;
        width: calc(100% - 280px);
        padding: 32px;
        min-height: 100vh;
        background: #F9F8F3; /* Fresh Cream White */
        font-family: "Inter", "Nunito", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #2C2C2C; /* Ink Black */
    }

    .audit-container {
        max-width: 1240px;
    }

    .audit-header {
        border-radius: 16px;
        background: #FFFFFF;
        border: 1px solid #E7E5D8; /* Tea Mist */
        border-top: 4px solid #D7A85A; /* Golden Whisk accent */
        box-shadow: 0 18px 35px rgba(139, 111, 71, 0.12);
    }

    .audit-title {
        font-family: "Cormorant Garamond", Georgia, serif;
        font-weight: 700;
        font-size: 30px;
        color: #4A6F47; /* Matcha Deep Green */
        letter-spacing: 0.03em;
    }

    .audit-subtitle {
        font-size: 0.95rem;
        color: #7B7B7B; /* Leaf Gray */
    }

    .btn-matcha-outline {
        background-color: #FFFFFF;
        border-color: #4A6F47;
        color: #4A6F47;
        font-weight: 500;
        padding: 0.6rem 1.4rem;
        border-radius: 8px;
        font-size: 0.85rem;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        transition: background-color 180ms ease-out, color 180ms ease-out, box-shadow 180ms ease-out, transform 180ms ease-out;
    }

    .btn-matcha-outline:hover {
        background-color: #A8C3A0; /* Matcha Soft Green */
        color: #FFFFFF;
        box-shadow: 0 10px 20px rgba(74, 111, 71, 0.25);
        transform: translateY(-1px);
    }

    .btn-azuki-outline {
        background-color: #FFFFFF;
        border-color: #B35A5A; /* Azuki Red */
        color: #B35A5A;
        font-weight: 500;
        padding: 0.6rem 1.4rem;
        border-radius: 8px;
        font-size: 0.85rem;
        letter-spacing: 0.04em;
        text-transform: uppercase;
        transition: background-color 180ms ease-out, color 180ms ease-out, box-shadow 180ms ease-out, transform 180ms ease-out;
    }

    .btn-azuki-outline:hover {
        background-color: #B35A5A;
        color: #FFFFFF;
        box-shadow: 0 10px 20px rgba(179, 90, 90, 0.25);
        transform: translateY(-1px);
    }

    .audit-filter-card {
        border-radius: 16px;
        background: #FFFFFF;
        border: 1px solid #E7E5D8;
    }

    .audit-search-input .input-group-text {
        border-radius: 10px 0 0 10px;
        border-color: #E7E5D8;
        background-color: #FFFFFF;
    }

    .audit-search-input .form-control {
        border-radius: 0 10px 10px 0;
        border-color: #E7E5D8;
    }

    .audit-select {
        border-radius: 10px;
        border-color: #E7E5D8;
        font-size: 0.9rem;
    }

    .audit-helper {
        border-radius: 10px;
        background-color: #FFF7E5;
        border: 1px solid #D7A85A;
        color: #8B6F47;
        padding: 0.6rem 0.9rem;
    }

    .audit-dot-success,
    .audit-dot-failure {
        display: inline-block;
        width: 8px;
        height: 8px;
        border-radius: 50%;
    }

    .audit-dot-success {
        background-color: #4A6F47;
    }

    .audit-dot-failure {
        background-color: #B35A5A;
    }

    .audit-table-card {
        border-radius: 16px;
        overflow: hidden;
        background: #FFFFFF;
        border: 1px solid #E7E5D8;
        box-shadow: 0 18px 35px rgba(44, 44, 44, 0.06);
    }

    .audit-table-head {
        background-color: #4A6F47; /* Matcha Deep Green */
        color: #000000; /* Header text black for better visibility */
        border-bottom: 2px solid #E7E5D8;
    }

    .audit-th {
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #000000; /* Header text black */
    }

    .audit-table tbody tr:nth-child(even) {
        background-color: #F9F8F3;
    }

    .audit-table tbody tr:nth-child(odd) {
        background-color: #FFFFFF;
    }

    .audit-table tbody tr:hover {
        background-color: #E3EDD9;
        transition: background-color 200ms ease-out;
    }

    .audit-table td {
        border-top: 1px solid #E7E5D8;
        padding: 0.85rem 0.75rem;
        vertical-align: middle;
    }

    .audit-mono {
        font-family: "JetBrains Mono", Consolas, monospace;
        font-size: 0.85rem;
    }

    .audit-details {
        max-width: 360px;
        display: inline-block;
        white-space: nowrap;
        overflow: hidden;
        text-overflow: ellipsis;
    }

    .audit-action {
        font-weight: 500;
        color: #2C2C2C;
    }

    .audit-ip {
        color: #5F6368;
    }

    .audit-badge-success {
        background-color: #4A6F47;
        color: #F9F8F3;
        padding: 0.25rem 0.7rem;
        border-radius: 999px;
        font-weight: 500;
        font-size: 0.78rem;
    }

    .audit-badge-failure {
        background-color: #B35A5A;
        color: #F9F8F3;
        padding: 0.25rem 0.7rem;
        border-radius: 999px;
        font-weight: 500;
        font-size: 0.78rem;
    }

    /* Slightly offset DataTables controls from the extreme edges */
    #auditLogsTable_wrapper .dataTables_length {
        margin-left: 0.75rem;
    }

    #auditLogsTable_wrapper .dataTables_filter {
        margin-right: 0.75rem;
    }

    @@media (max-width: 991.98px) {
        .audit-main {
            margin-left: 0;
            width: 100%;
            padding: 20px 16px;
        }

        .audit-details {
            max-width: 220px;
        }
    }
</style>

@section Scripts {
    <script>
        document.addEventListener('DOMContentLoaded', function () {
            // Initialize DataTable if available
            setTimeout(function () {
                const tableSelector = '#auditLogsTable';
                const table = document.querySelector(tableSelector);

                if (table && typeof jQuery !== 'undefined' && jQuery.fn.DataTable && typeof initDataTable === 'function') {
                    if (jQuery.fn.DataTable.isDataTable(tableSelector)) {
                        jQuery(tableSelector).DataTable().destroy();
                    }

                    initDataTable(tableSelector, {
                        pageLength: 25,
                        lengthMenu: [[25, 50, 100, -1], [25, 50, 100, 'All']],
                        order: [[0, 'desc']],
                        responsive: true,
                        scrollY: false,
                        paging: true,
                        searching: true,
                        language: {
                            search: 'Search:',
                            lengthMenu: 'Show _MENU_ entries',
                            info: 'Showing _START_ to _END_ of _TOTAL_ entries',
                            infoEmpty: 'No entries to show',
                            infoFiltered: '(filtered from _MAX_ total entries)',
                            zeroRecords: 'No matching records found',
                            paginate: {
                                first: 'First',
                                last: 'Last',
                                next: 'Next',
                                previous: 'Previous'
                            }
                        }
                    });
                }

                // Hook up client-side filters if DataTable is present
                const statusFilter = document.getElementById('auditStatusFilter');
                const searchInput = document.getElementById('auditSearch');

                function applyFilters() {
                    if (!jQuery || !jQuery.fn.DataTable) return;
                    const dt = jQuery(tableSelector).DataTable();

                    // Global search
                    const searchText = (searchInput?.value || '').trim();
                    dt.search(searchText);

                    // Status filter (Success / Failure)
                    const status = statusFilter?.value || '';
                    if (status) {
                        dt.column(5).search(status, true, false); // exact match on Status column
                    } else {
                        dt.column(5).search('');
                    }

                    dt.draw();
                }

                if (searchInput) {
                    searchInput.addEventListener('input', function () {
                        applyFilters();
                    });
                }

                if (statusFilter) {
                    statusFilter.addEventListener('change', function () {
                        applyFilters();
                    });
                }
            }, 300);
        });
    </script>
}