@page "/Admin/ManageLeases"
@model Apartment.Pages.Admin.ManageLeasesModel
@using System.Globalization
@{
    ViewData["Title"] = "Lease Management";
    Layout = "_Layout";
    var pesoCulture = CultureInfo.CreateSpecificCulture("en-PH");
}

<div class="d-flex matcha-shell">
    @await Html.PartialAsync("_AdminSidebar")

    <!-- Main Content -->
    <div class="main-content leases-main">
        <div class="container-fluid leases-container">
            @* Standardized Messages *@
            @{
                ViewData["SuccessMessage"] = Model.SuccessMessage;
                ViewData["ErrorMessage"] = Model.ErrorMessage;
            }
            @await Html.PartialAsync("_MessagePartial")

            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="leases-header card border-0 shadow-sm">
                        <div class="card-body d-flex justify-content-between align-items-start flex-wrap gap-3">
                            <div>
                                <h1 class="leases-title mb-1">
                                    <i class="bi bi-file-earmark-text me-2"></i>Lease Management
                                </h1>
                                <p class="leases-subtitle mb-0">Create, view, edit, and print lease agreements.</p>
                            </div>
                            <div class="d-flex gap-3 flex-wrap">
                                <button type="button" class="btn btn-matcha-secondary" id="printLeasesBtn">
                                    <i class="bi bi-printer me-1"></i>Print selected
                                </button>
                                <button type="button" class="btn btn-matcha-primary" data-bs-toggle="modal" data-bs-target="#leaseModal" onclick="resetLeaseForm()">
                                    <i class="bi bi-plus-circle me-2"></i>Create new lease
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Leases Table -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-0 shadow-sm leases-table-card">
                        <div class="card-body p-0">
                            @if (Model.Leases.Any())
                            {
                                <div class="leases-table-wrapper">
                                    <table class="table table-hover mb-0 data-table leases-table" id="leasesTable">
                                        <thead class="leases-table-head">
                                            <tr>
                                                <th class="border-0 ps-4 leases-th"></th>
                                                <th class="border-0 leases-th">Tenant</th>
                                                <th class="border-0 leases-th">Unit</th>
                                                <th class="border-0 leases-th text-end">Monthly Rent</th>
                                                <th class="border-0 leases-th text-end">Security Deposit</th>
                                                <th class="border-0 leases-th text-end">Late Fee</th>
                                                <th class="border-0 leases-th">Late Days</th>
                                                <th class="border-0 leases-th">Pets</th>
                                                <th class="border-0 leases-th">Start Date</th>
                                                <th class="border-0 leases-th">End Date</th>
                                                <th class="border-0 leases-th">Status</th>
                                                <th class="border-0 text-center pe-4 leases-th">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var lease in Model.Leases)
                                            {
                                                <tr>
                                                    <td class="align-middle ps-4">
                                                        <input type="checkbox" class="lease-select" value="@lease.Id" />
                                                    </td>
                                                    <td class="align-middle">
                                                        <div class="fw-semibold leases-tenant">@lease.TenantName</div>
                                                        <div class="text-muted small">@lease.TenantEmail</div>
                                                    </td>
                                                    <td class="align-middle">
                                                        <span class="fw-medium leases-unit">@lease.ApartmentUnit</span>
                                                        <div class="text-muted small">
                                                            @if (lease.ApartmentStatus == "Occupied")
                                                            {
                                                                <span class="badge bg-primary">@lease.ApartmentStatus</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge bg-secondary">@lease.ApartmentStatus</span>
                                                            }
                                                        </div>
                                                    </td>
                                                    <td class="align-middle text-end">
                                                        <span class="leases-money leases-money-strong">@lease.MonthlyRent.ToString("C", pesoCulture)</span>
                                                    </td>
                                                    <td class="align-middle text-end">
                                                        <span class="leases-money">@lease.SecurityDeposit.ToString("C", pesoCulture)</span>
                                                    </td>
                                                    <td class="align-middle text-end">
                                                        <span class="leases-money">@lease.LateFeeAmount.ToString("C", pesoCulture)</span>
                                                    </td>
                                                    <td class="align-middle">
                                                        <span class="leases-mono">@lease.LateFeeDays</span>
                                                    </td>
                                                    <td class="align-middle">
                                                        @if (lease.PetsAllowed)
                                                        {
                                                            <span class="badge badge-green">Allowed</span>
                                                        }
                                                        else
                                                        {
                                                            <span class="badge badge-gray">Not Allowed</span>
                                                        }
                                                    </td>
                                                    <td class="align-middle">
                                                        <div class="text-muted small leases-mono">@lease.LeaseStart.ToString("MMM dd, yyyy")</div>
                                                    </td>
                                                    <td class="align-middle">
                                                        <div class="text-muted small leases-mono">@lease.LeaseEnd.ToString("MMM dd, yyyy")</div>
                                                    </td>
                                                    <td class="align-middle">
                                                        @{
                                                            var statusBadgeClass = lease.LeaseStatus switch
                                                            {
                                                                "Active" => "bg-success",
                                                                "Upcoming" => "bg-info",
                                                                "Expired" => "bg-secondary",
                                                                _ => "bg-secondary"
                                                            };
                                                        }
                                                        <span class="badge @statusBadgeClass">@lease.LeaseStatus</span>
                                                    </td>
                                                    <td class="align-middle text-center pe-4">
                                                        <div class="btn-group" role="group">
                                                            @if (lease.LeaseStatus == "Expired")
                                                            {
                                                                <button type="button" class="btn btn-outline-primary btn-sm" 
                                                                        data-bs-toggle="modal" 
                                                                        data-bs-target="#leaseModal"
                                                                        onclick="loadLeaseForEdit(@lease.Id)">
                                                                    <i class="bi bi-pencil-square"></i>
                                                                </button>
                                                            }
                                                            else
                                                            {
                                                                <button type="button" class="btn btn-outline-secondary btn-sm" 
                                                                        disabled
                                                                        title="Lease cannot be edited until it expires on @lease.LeaseEnd.ToString("MMM dd, yyyy")">
                                                                    <i class="bi bi-pencil-square"></i>
                                                                </button>
                                                            }
                                                            <button type="button" class="btn btn-outline-danger btn-sm" 
                                                                    data-bs-toggle="modal" 
                                                                    data-bs-target="#deleteLeaseModal"
                                                                    data-lease-id="@lease.Id"
                                                                    data-tenant-name="@lease.TenantName"
                                                                    data-unit-number="@lease.ApartmentUnit">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-5">
                                    <i class="bi bi-file-earmark-text" style="font-size: 3rem; color: #ccc;"></i>
                                    <p class="text-muted mt-3">No leases found. Create your first lease to get started.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Lease Modal -->
<div class="modal fade" id="leaseModal" tabindex="-1" aria-labelledby="leaseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 12px;">
            <div class="modal-header matcha-modal-header text-white">
                <h5 class="modal-title fw-bold" id="leaseModalLabel">
                    <i class="bi bi-file-earmark-text me-2"></i><span id="modalTitle">CREATE NEW LEASE</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="leaseForm" method="post" asp-page-handler="CreateLease">
                <div class="modal-body p-4 matcha-modal-body">
                    <input type="hidden" id="leaseId" asp-for="LeaseInput.Id" />

                    <!-- Tenant Information Section -->
                    <div class="mb-4">
                        <div class="card border-0 shadow-sm matcha-card">
                            <div class="card-header matcha-card-header text-white">
                                <h6 class="mb-0 fw-semibold">
                                    <i class="bi bi-person-fill me-2"></i>Tenant Information
                                </h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="mb-3">
                                    <label asp-for="LeaseInput.UserId" class="form-label fw-semibold">
                                        <i class="bi bi-person me-1"></i>Select Tenant
                                    </label>
                                    <select asp-for="LeaseInput.UserId" 
                                            asp-items="Model.AvailableTenants" 
                                            class="form-select" 
                                            id="tenantSelect"
                                            required>
                                        <option value="">-- Select Tenant --</option>
                                    </select>
                                    <span asp-validation-for="LeaseInput.UserId" class="text-danger small"></span>
                                </div>
                                <div class="mb-0">
                                    <label class="form-label fw-semibold">
                                        <i class="bi bi-info-circle me-1"></i>Tenant Email
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="tenantEmailDisplay" 
                                           readonly 
                                           placeholder="Select a tenant to view email"
                                           style="background-color: #f8f9fa;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Apartment Information Section -->
                    <div class="mb-4">
                        <div class="card border-0 shadow-sm matcha-card">
                            <div class="card-header matcha-card-header text-white">
                                <h6 class="mb-0 fw-semibold">
                                    <i class="bi bi-house-door-fill me-2"></i>Apartment Information
                                </h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="mb-3">
                                    <label asp-for="LeaseInput.ApartmentId" class="form-label fw-semibold">
                                        <i class="bi bi-building me-1"></i>Select Apartment
                                    </label>
                                    <select asp-for="LeaseInput.ApartmentId" 
                                            asp-items="Model.AvailableApartments" 
                                            class="form-select" 
                                            id="apartmentSelect"
                                            required>
                                        <option value="">-- Select Apartment --</option>
                                    </select>
                                    <span asp-validation-for="LeaseInput.ApartmentId" class="text-danger small"></span>
                                </div>
                                <div class="mb-0">
                                    <label class="form-label fw-semibold">
                                        <i class="bi bi-info-circle me-1"></i>Apartment Status
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="apartmentStatusDisplay" 
                                           readonly 
                                           placeholder="Select an apartment to view status"
                                           style="background-color: #f8f9fa;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lease Details -->
                    <div class="row mb-3">
                        <div class="col-md-6 mb-3">
                            <label asp-for="LeaseInput.LeaseStart" class="form-label fw-semibold">
                                <i class="bi bi-calendar-event me-1"></i>Lease Start Date
                            </label>
                            <input asp-for="LeaseInput.LeaseStart" 
                                   type="text" 
                                   class="form-control" 
                                   required />
                            <span asp-validation-for="LeaseInput.LeaseStart" class="text-danger small"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="LeaseInput.LeaseEnd" class="form-label fw-semibold">
                                <i class="bi bi-calendar-x me-1"></i>Lease End Date
                            </label>
                            <input asp-for="LeaseInput.LeaseEnd" 
                                   type="text" 
                                   class="form-control" 
                                   required />
                            <span asp-validation-for="LeaseInput.LeaseEnd" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6 mb-3">
                            <label asp-for="LeaseInput.MonthlyRent" class="form-label fw-semibold">
                                <i class="bi bi-currency-dollar me-1"></i>Monthly Rent
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">₱</span>
                                <input asp-for="LeaseInput.MonthlyRent" 
                                       type="number" 
                                       step="0.01" 
                                       min="0" 
                                       class="form-control" 
                                       placeholder="0.00"
                                       required />
                            </div>
                            <span asp-validation-for="LeaseInput.MonthlyRent" class="text-danger small"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="LeaseInput.SecurityDeposit" class="form-label fw-semibold">
                                <i class="bi bi-shield-check me-1"></i>Security Deposit
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">₱</span>
                                <input asp-for="LeaseInput.SecurityDeposit" 
                                       type="number" 
                                       step="0.01" 
                                       min="0" 
                                       class="form-control" 
                                       placeholder="0.00"
                                       required />
                            </div>
                            <span asp-validation-for="LeaseInput.SecurityDeposit" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6 mb-3">
                            <label asp-for="LeaseInput.LateFeeAmount" class="form-label fw-semibold">
                                <i class="bi bi-cash-coin me-1"></i>Late Fee Amount
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">₱</span>
                                <input asp-for="LeaseInput.LateFeeAmount"
                                       type="number"
                                       step="0.01"
                                       min="0"
                                       class="form-control"
                                       placeholder="0.00" />
                            </div>
                            <span asp-validation-for="LeaseInput.LateFeeAmount" class="text-danger small"></span>
                        </div>
                        <div class="col-md-3 mb-3">
                            <label asp-for="LeaseInput.LateFeeDays" class="form-label fw-semibold">
                                <i class="bi bi-clock-history me-1"></i>Late After (Days)
                            </label>
                            <input asp-for="LeaseInput.LateFeeDays"
                                   type="number"
                                   min="0"
                                   class="form-control"
                                   placeholder="0" />
                            <span asp-validation-for="LeaseInput.LateFeeDays" class="text-danger small"></span>
                        </div>
                        <div class="col-md-3 mb-3 d-flex align-items-end">
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" asp-for="LeaseInput.PetsAllowed" />
                                <label class="form-check-label fw-semibold" asp-for="LeaseInput.PetsAllowed">
                                    <i class="bi bi-paw me-1"></i>Pets Allowed
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-info-circle me-1"></i>Lease Status
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="leaseStatusDisplay" 
                               readonly 
                               placeholder="Calculated based on dates"
                               style="background-color: #f8f9fa;">
                    </div>
                </div>
                <div class="modal-footer matcha-modal-footer">
                    <button type="button" class="btn btn-matcha-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-matcha-primary" id="saveLeaseBtn">
                        <i class="bi bi-check-circle me-2"></i>Save Lease
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Lease Modal -->
<div class="modal fade" id="deleteLeaseModal" tabindex="-1" aria-labelledby="deleteLeaseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content matcha-danger-modal">
            <div class="modal-header matcha-danger-header text-white">
                <h5 class="modal-title fw-bold" id="deleteLeaseModalLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i>Delete Lease
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" asp-page-handler="DeleteLease" id="deleteLeaseForm">
                <div class="modal-body p-4">
                    <input type="hidden" id="deleteLeaseId" name="id" />
                    <div class="text-center">
                        <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">Are you sure you want to delete this lease?</h5>
                        <p class="text-muted">This action cannot be undone.</p>
                        <div class="alert alert-warning">
                            <strong>Tenant:</strong> <span id="deleteTenantName"></span><br>
                            <strong>Unit:</strong> <span id="deleteUnitNumber"></span>
                        </div>
                    </div>
                    <div class="mt-4">
                        <label for="adminPassword" class="form-label fw-semibold">
                            <i class="bi bi-shield-lock me-1"></i>Confirm Your Password
                        </label>
                        <p class="text-muted small mb-2">Please enter your admin password to confirm this deletion.</p>
                        <input type="password" 
                               class="form-control" 
                               id="adminPassword" 
                               name="adminPassword" 
                               placeholder="Enter your password"
                               required 
                               autocomplete="current-password" />
                        <div class="invalid-feedback" id="passwordError"></div>
                    </div>
                </div>
                <div class="modal-footer matcha-modal-footer">
                    <button type="button" class="btn btn-matcha-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-matcha-danger" id="confirmDeleteBtn">
                        <i class="bi bi-trash me-2"></i>Delete Lease
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Reset form when creating new lease
        function resetLeaseForm() {
            const form = document.getElementById('leaseForm');
            const apartmentSelect = document.getElementById('apartmentSelect');

            form.action = '?handler=CreateLease';
            document.getElementById('modalTitle').textContent = 'CREATE NEW LEASE';
            document.getElementById('leaseId').value = '0';
            form.reset();
            document.getElementById('tenantEmailDisplay').value = '';
            document.getElementById('apartmentStatusDisplay').value = '';
            document.getElementById('leaseStatusDisplay').value = '';
            document.getElementById('saveLeaseBtn').innerHTML = '<i class="bi bi-check-circle me-2"></i>Save Lease';

            // For CREATE mode: only allow selecting apartments that are currently vacant.
            // We infer vacancy from the option text "(Vacant)" vs "(Occupied)".
            if (apartmentSelect) {
                for (let i = 0; i < apartmentSelect.options.length; i++) {
                    const opt = apartmentSelect.options[i];
                    if (!opt.value) continue; // skip placeholder
                    const text = opt.text || '';
                    opt.disabled = text.includes('(Occupied)');
                }
                // Reset selection
                apartmentSelect.value = '';
                updateApartmentStatus();
            }
        }

        // Load lease data for editing
        async function loadLeaseForEdit(leaseId) {
            try {
                const response = await fetch(`?handler=LeaseDetails&id=${leaseId}`);
                const data = await response.json();
                
                if (data.error) {
                    Swal.fire({
                        icon: 'error',
                        title: 'Error',
                        text: data.error,
                        confirmButtonColor: '#4A6F47'
                    });
                    return;
                }

                // Check if lease has expired - prevent editing if not expired
                if (!data.isExpired) {
                    Swal.fire({
                        icon: 'warning',
                        title: 'Cannot Edit Lease',
                        html: `This lease cannot be edited until it expires.<br><strong>Expiration Date: ${data.expirationDate}</strong><br><br>Only expired leases can be modified.`,
                        confirmButtonColor: '#4A6F47',
                        confirmButtonText: 'OK'
                    });
                    // Close the modal if it's open
                    const modal = bootstrap.Modal.getInstance(document.getElementById('leaseModal'));
                    if (modal) {
                        modal.hide();
                    }
                    return;
                }

                const form = document.getElementById('leaseForm');
                const apartmentSelect = document.getElementById('apartmentSelect');
                form.action = '?handler=EditLease';
                document.getElementById('modalTitle').textContent = 'EDIT LEASE';
                document.getElementById('leaseId').value = data.id;
                document.getElementById('tenantSelect').value = data.userId;
                document.getElementById('apartmentSelect').value = data.apartmentId;
                document.getElementById('LeaseInput_LeaseStart').value = data.leaseStart;
                document.getElementById('LeaseInput_LeaseEnd').value = data.leaseEnd;
                document.getElementById('LeaseInput_MonthlyRent').value = data.monthlyRent;
                document.getElementById('LeaseInput_SecurityDeposit').value = data.securityDeposit;
                document.getElementById('LeaseInput_LateFeeAmount').value = data.lateFeeAmount || 0;
                document.getElementById('LeaseInput_LateFeeDays').value = data.lateFeeDays || 0;
                document.getElementById('LeaseInput_PetsAllowed').checked = data.petsAllowed || false;
                document.getElementById('leaseStatusDisplay').value = data.status;
                document.getElementById('saveLeaseBtn').innerHTML = '<i class="bi bi-check-circle me-2"></i>Update Lease';

                // For EDIT mode: allow selecting any apartment (including occupied),
                // since we're modifying an existing lease and may need to keep or move it.
                if (apartmentSelect) {
                    for (let i = 0; i < apartmentSelect.options.length; i++) {
                        apartmentSelect.options[i].disabled = false;
                    }
                }

                // Update tenant email display
                updateTenantEmail();
                // Update apartment status display
                updateApartmentStatus();
            } catch (error) {
                console.error('Error loading lease:', error);
                Swal.fire({
                    icon: 'error',
                    title: 'Error',
                    text: 'Error loading lease details.',
                    confirmButtonColor: '#4A6F47'
                });
            }
        }

        // Update tenant email when tenant is selected
        document.getElementById('tenantSelect')?.addEventListener('change', updateTenantEmail);
        function updateTenantEmail() {
            const select = document.getElementById('tenantSelect');
            const selectedOption = select.options[select.selectedIndex];
            const emailDisplay = document.getElementById('tenantEmailDisplay');
            
            if (selectedOption && selectedOption.value) {
                // Extract email from option text (format: "Name (email)")
                const text = selectedOption.text;
                const emailMatch = text.match(/\(([^)]+)\)/);
                if (emailMatch) {
                    emailDisplay.value = emailMatch[1];
                } else {
                    emailDisplay.value = selectedOption.text;
                }
            } else {
                emailDisplay.value = '';
            }
        }

        // Update apartment status when apartment is selected
        document.getElementById('apartmentSelect')?.addEventListener('change', updateApartmentStatus);
        function updateApartmentStatus() {
            const select = document.getElementById('apartmentSelect');
            const selectedOption = select.options[select.selectedIndex];
            const statusDisplay = document.getElementById('apartmentStatusDisplay');
            
            if (selectedOption && selectedOption.value) {
                // Check if text contains "(Occupied)"
                const text = selectedOption.text;
                if (text.includes('(Occupied)')) {
                    statusDisplay.value = 'Occupied';
                } else {
                    statusDisplay.value = 'Available';
                }
            } else {
                statusDisplay.value = '';
            }
        }

        // Update lease status based on dates
        document.getElementById('LeaseInput_LeaseStart')?.addEventListener('change', updateLeaseStatus);
        document.getElementById('LeaseInput_LeaseEnd')?.addEventListener('change', updateLeaseStatus);
        function updateLeaseStatus() {
            const startDate = new Date(document.getElementById('LeaseInput_LeaseStart').value);
            const endDate = new Date(document.getElementById('LeaseInput_LeaseEnd').value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const statusDisplay = document.getElementById('leaseStatusDisplay');
            
            if (!startDate || !endDate || isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                statusDisplay.value = '';
                return;
            }
            
            if (today < startDate) {
                statusDisplay.value = 'Upcoming';
            } else if (today >= startDate && today <= endDate) {
                statusDisplay.value = 'Active';
            } else {
                statusDisplay.value = 'Expired';
            }
        }

        // Delete modal handler
        const deleteLeaseModal = document.getElementById('deleteLeaseModal');
        if (deleteLeaseModal) {
            deleteLeaseModal.addEventListener('show.bs.modal', function (event) {
                const button = event.relatedTarget;
                const leaseId = button.getAttribute('data-lease-id');
                const tenantName = button.getAttribute('data-tenant-name');
                const unitNumber = button.getAttribute('data-unit-number');

                document.getElementById('deleteLeaseId').value = leaseId;
                document.getElementById('deleteTenantName').textContent = tenantName;
                document.getElementById('deleteUnitNumber').textContent = unitNumber;
                
                // Clear password field when modal opens
                const passwordField = document.getElementById('adminPassword');
                if (passwordField) {
                    passwordField.value = '';
                    passwordField.classList.remove('is-invalid');
                }
            });

            // Clear password field when modal is hidden
            deleteLeaseModal.addEventListener('hidden.bs.modal', function () {
                const passwordField = document.getElementById('adminPassword');
                if (passwordField) {
                    passwordField.value = '';
                    passwordField.classList.remove('is-invalid');
                }
                const passwordError = document.getElementById('passwordError');
                if (passwordError) {
                    passwordError.textContent = '';
                }
            });
        }

        // Form validation for delete lease
        const deleteLeaseForm = document.getElementById('deleteLeaseForm');
        if (deleteLeaseForm) {
            deleteLeaseForm.addEventListener('submit', function(e) {
                const passwordField = document.getElementById('adminPassword');
                const passwordError = document.getElementById('passwordError');
                
                if (!passwordField || !passwordField.value.trim()) {
                    e.preventDefault();
                    passwordField.classList.add('is-invalid');
                    passwordError.textContent = 'Password is required to confirm deletion.';
                    passwordField.focus();
                    return false;
                }
                
                // Show loading state
                const submitBtn = document.getElementById('confirmDeleteBtn');
                if (submitBtn) {
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status" aria-hidden="true"></span>Deleting...';
                }
                
                return true;
            });
        }

        // Set form action based on whether it's create or edit
        document.getElementById('leaseForm')?.addEventListener('submit', function(e) {
            const leaseId = document.getElementById('leaseId').value;
            const form = this;
            
            // Set the correct handler based on lease ID
            if (leaseId && leaseId !== '0') {
                form.action = '?handler=EditLease';
            } else {
                form.action = '?handler=CreateLease';
            }
        });

        // Export selected leases to PDF via server-side handler
        document.getElementById('printLeasesBtn')?.addEventListener('click', function () {
            const selectedLeaseIds = Array.from(document.querySelectorAll('.lease-select:checked'))
                .map(cb => cb.value);

            if (selectedLeaseIds.length === 0) {
                alert('Please select at least one lease to export to PDF.');
                return;
            }

            // Create a form dynamically to submit the selected IDs to the server
            const form = document.createElement('form');
            form.method = 'post';
            form.action = '?handler=ExportLeasesPdf';
            form.style.display = 'none'; // Hide the form

            // Include the existing anti-forgery token so the POST is valid
            const existingToken = document.querySelector('input[name="__RequestVerificationToken"]');
            if (existingToken) {
                const tokenInput = document.createElement('input');
                tokenInput.type = 'hidden';
                tokenInput.name = '__RequestVerificationToken';
                tokenInput.value = existingToken.value;
                form.appendChild(tokenInput);
            }

            selectedLeaseIds.forEach(id => {
                const input = document.createElement('input');
                input.type = 'hidden';
                input.name = 'selectedLeaseIds';
                input.value = id;
                form.appendChild(input);
            });

            document.body.appendChild(form); // Append to the document body
            form.submit(); // Submit the form
            document.body.removeChild(form); // Clean up the form after submission
        });
    </script>
}

<style>
    .matcha-shell {
        background: #F9F8F3;
    }

    .leases-main {
        margin-left: 280px;
        width: calc(100% - 280px);
        padding: 32px;
        min-height: 100vh;
        background: #F9F8F3;
        font-family: "Inter", "Nunito", -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
        color: #2C2C2C;
    }

    .leases-container {
        max-width: 1240px;
    }

    .leases-header {
        border-radius: 16px;
        background: #FFFFFF;
        border: 1px solid #E7E5D8;
        border-top: 4px solid #D7A85A;
        box-shadow: 0 18px 35px rgba(139, 111, 71, 0.12);
    }

    .leases-title {
        font-family: "Cormorant Garamond", Georgia, serif;
        font-weight: 700;
        font-size: 30px;
        color: #4A6F47;
        letter-spacing: 0.03em;
    }

    .leases-subtitle {
        font-size: 16px;
        color: #7B7B7B;
    }

    .leases-table-card {
        border-radius: 16px;
        overflow: hidden;
        background: #FFFFFF;
        border: 1px solid #E7E5D8;
        box-shadow: 0 18px 35px rgba(44, 44, 44, 0.06);
    }

    .leases-table-head {
        background-color: #F3F6F1;
        color: #2C2C2C;
        border-bottom: 2px solid #E7E5D8;
    }

    .leases-table-wrapper {
        overflow-x: visible;
    }

    .leases-th {
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        color: #2C2C2C;
    }

    .leases-table tbody tr:nth-child(even) {
        background-color: #F3F6F1;
    }

    .leases-table tbody tr:nth-child(odd) {
        background-color: #FFFFFF;
    }

    .leases-table tbody tr:hover {
        background-color: #E3EDD9;
        transition: background-color 200ms ease-out;
    }

    .leases-tenant,
    .leases-unit {
        color: #2C2C2C;
    }

    .leases-money {
        font-family: "JetBrains Mono", Consolas, monospace;
        font-size: 0.9rem;
    }

    .leases-money-strong {
        font-weight: 600;
    }

    .leases-mono {
        font-family: "JetBrains Mono", Consolas, monospace;
    }

    .badge-green {
        background-color: #4A6F47;
        color: #F9F8F3;
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 0.75rem;
    }

    .badge-gray {
        background-color: #E7E5D8;
        color: #7B7B7B;
        border-radius: 999px;
        padding: 4px 10px;
        font-size: 0.75rem;
    }

    .btn-matcha-primary {
        background-color: #4A6F47;
        border-color: #4A6F47;
        color: #FFFFFF;
        border-radius: 8px;
        padding: 10px 20px;
        font-weight: 600;
        transition: background-color 180ms ease-out, box-shadow 180ms ease-out, transform 180ms ease-out;
    }

    .btn-matcha-primary:hover {
        background-color: #7DA26C;
        border-color: #7DA26C;
        color: #FFFFFF;
        box-shadow: 0 10px 20px rgba(74, 111, 71, 0.25);
        transform: translateY(-1px);
    }

    .btn-matcha-secondary {
        background-color: transparent;
        color: #4A6F47;
        border-radius: 8px;
        border: 1px solid #4A6F47;
        padding: 10px 18px;
        font-weight: 500;
        transition: background-color 180ms ease-out, color 180ms ease-out, border-color 180ms ease-out;
    }

    .btn-matcha-secondary:hover {
        background-color: #A8C3A0;
        color: #2C2C2C;
        border-color: #4A6F47;
    }

    .btn-matcha-danger {
        background-color: #B35A5A;
        border-color: #B35A5A;
        color: #FFFFFF;
        border-radius: 8px;
        padding: 10px 18px;
        font-weight: 600;
        transition: background-color 180ms ease-out, box-shadow 180ms ease-out;
    }

    .btn-matcha-danger:hover {
        background-color: #8F4141;
        border-color: #8F4141;
        box-shadow: 0 10px 20px rgba(179, 90, 90, 0.25);
    }

    .matcha-modal-header {
        background: linear-gradient(135deg, #4A6F47, #7DA26C);
        border-radius: 12px 12px 0 0;
        border-bottom: none;
    }

    .matcha-modal-body {
        background-color: #F9F8F3;
    }

    .matcha-modal-footer {
        border-top: 1px solid #E7E5D8;
        background-color: #F9F8F3;
    }

    .matcha-card {
        border-radius: 12px;
        background-color: #FFFFFF;
        border: 1px solid #E7E5D8;
    }

    .matcha-card-header {
        background: #4A6F47;
        border-radius: 12px 12px 0 0;
        padding: 0.75rem 1rem;
    }

    .matcha-danger-modal {
        border-radius: 16px;
        background-color: #FFFFFF;
        border: 1px solid #E7E5D8;
        box-shadow: 0 18px 35px rgba(179, 90, 90, 0.2);
    }

    .matcha-danger-header {
        background: #B35A5A;
        border-radius: 16px 16px 0 0;
    }
</style>

