@page "/Admin/ManageLeases"
@model Apartment.Pages.Admin.ManageLeasesModel
@using System.Globalization
@{
    ViewData["Title"] = "Lease Management";
    Layout = "_Layout";
    var pesoCulture = CultureInfo.CreateSpecificCulture("en-PH");
}

<div class="d-flex">
    @await Html.PartialAsync("_AdminSidebar")

    <!-- Main Content -->
    <div class="main-content" style="margin-left: 280px; width: calc(100% - 280px); padding: 2rem; background-color: #FAFAF5; min-height: 100vh;">
        <div class="container-fluid">
            @* Standardized Messages *@
            @{
                ViewData["SuccessMessage"] = Model.SuccessMessage;
                ViewData["ErrorMessage"] = Model.ErrorMessage;
            }
            @await Html.PartialAsync("_MessagePartial")

            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="d-flex justify-content-between align-items-start">
                        <div>
                            <h2 class="mb-1" style="font-weight: 600; color: #2c3e50;">Lease Management</h2>
                            <p class="text-muted mb-0" style="font-size: 0.95rem;">Create, view, edit, and delete lease agreements.</p>
                        </div>
                        <button type="button" class="btn btn-success btn-lg shadow-sm" data-bs-toggle="modal" data-bs-target="#leaseModal" onclick="resetLeaseForm()">
                            <i class="bi bi-plus-circle me-2"></i>Create New Lease
                        </button>
                    </div>
                </div>
            </div>

            <!-- Leases Table -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-0 shadow-sm" style="border-radius: 12px;">
                        <div class="card-body p-0">
                            @if (Model.Leases.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0 data-table" id="leasesTable">
                                        <thead class="table-light" style="border-bottom: 2px solid #f1f3f4;">
                                            <tr>
                                                <th class="border-0 ps-4" style="font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; color: #5f6368;">Tenant</th>
                                                <th class="border-0" style="font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; color: #5f6368;">Unit</th>
                                                <th class="border-0" style="font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; color: #5f6368;">Monthly Rent</th>
                                                <th class="border-0" style="font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; color: #5f6368;">Security Deposit</th>
                                                <th class="border-0" style="font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; color: #5f6368;">Start Date</th>
                                                <th class="border-0" style="font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; color: #5f6368;">End Date</th>
                                                <th class="border-0" style="font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; color: #5f6368;">Status</th>
                                                <th class="border-0 text-center pe-4" style="font-weight: 600; font-size: 0.875rem; text-transform: uppercase; letter-spacing: 0.5px; color: #5f6368;">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var lease in Model.Leases)
                                            {
                                                <tr>
                                                    <td class="align-middle ps-4">
                                                        <div class="fw-semibold" style="color: #202124;">@lease.TenantName</div>
                                                        <div class="text-muted small">@lease.TenantEmail</div>
                                                    </td>
                                                    <td class="align-middle">
                                                        <span class="fw-medium" style="color: #202124;">@lease.ApartmentUnit</span>
                                                        <div class="text-muted small">
                                                            @if (lease.ApartmentStatus == "Occupied")
                                                            {
                                                                <span class="badge bg-primary">@lease.ApartmentStatus</span>
                                                            }
                                                            else
                                                            {
                                                                <span class="badge bg-secondary">@lease.ApartmentStatus</span>
                                                            }
                                                        </div>
                                                    </td>
                                                    <td class="align-middle">
                                                        <span class="text-success fw-semibold">@lease.MonthlyRent.ToString("C", pesoCulture)</span>
                                                    </td>
                                                    <td class="align-middle">
                                                        <span class="fw-medium">@lease.SecurityDeposit.ToString("C", pesoCulture)</span>
                                                    </td>
                                                    <td class="align-middle">
                                                        <div class="text-muted small">@lease.LeaseStart.ToString("MMM dd, yyyy")</div>
                                                    </td>
                                                    <td class="align-middle">
                                                        <div class="text-muted small">@lease.LeaseEnd.ToString("MMM dd, yyyy")</div>
                                                    </td>
                                                    <td class="align-middle">
                                                        @{
                                                            var statusBadgeClass = lease.LeaseStatus switch
                                                            {
                                                                "Active" => "bg-success",
                                                                "Upcoming" => "bg-info",
                                                                "Expired" => "bg-secondary",
                                                                _ => "bg-secondary"
                                                            };
                                                        }
                                                        <span class="badge @statusBadgeClass">@lease.LeaseStatus</span>
                                                    </td>
                                                    <td class="align-middle text-center pe-4">
                                                        <div class="btn-group" role="group">
                                                            <button type="button" class="btn btn-outline-primary btn-sm" 
                                                                    data-bs-toggle="modal" 
                                                                    data-bs-target="#leaseModal"
                                                                    onclick="loadLeaseForEdit(@lease.Id)">
                                                                <i class="bi bi-pencil-square"></i>
                                                            </button>
                                                            <button type="button" class="btn btn-outline-danger btn-sm" 
                                                                    data-bs-toggle="modal" 
                                                                    data-bs-target="#deleteLeaseModal"
                                                                    data-lease-id="@lease.Id"
                                                                    data-tenant-name="@lease.TenantName"
                                                                    data-unit-number="@lease.ApartmentUnit">
                                                                <i class="bi bi-trash"></i>
                                                            </button>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <div class="text-center py-5">
                                    <i class="bi bi-file-earmark-text" style="font-size: 3rem; color: #ccc;"></i>
                                    <p class="text-muted mt-3">No leases found. Create your first lease to get started.</p>
                                </div>
                            }
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Create/Edit Lease Modal -->
<div class="modal fade" id="leaseModal" tabindex="-1" aria-labelledby="leaseModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="border-radius: 12px;">
            <div class="modal-header bg-primary text-white" style="border-radius: 12px 12px 0 0;">
                <h5 class="modal-title fw-bold" id="leaseModalLabel">
                    <i class="bi bi-file-earmark-text me-2"></i><span id="modalTitle">CREATE NEW LEASE</span>
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="leaseForm" method="post" action="?handler=CreateLease">
                <div class="modal-body p-4" style="background-color: #FAFAF5;">
                    <input type="hidden" id="leaseId" asp-for="LeaseInput.Id" />

                    <!-- Tenant Information Section -->
                    <div class="mb-4">
                        <div class="card border-0 shadow-sm" style="border-radius: 8px;">
                            <div class="card-header bg-success text-white" style="border-radius: 8px 8px 0 0; padding: 0.75rem 1rem;">
                                <h6 class="mb-0 fw-semibold">
                                    <i class="bi bi-person-fill me-2"></i>Tenant Information
                                </h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="mb-3">
                                    <label asp-for="LeaseInput.UserId" class="form-label fw-semibold">
                                        <i class="bi bi-person me-1"></i>Select Tenant
                                    </label>
                                    <select asp-for="LeaseInput.UserId" 
                                            asp-items="Model.AvailableTenants" 
                                            class="form-select" 
                                            id="tenantSelect"
                                            required>
                                        <option value="">-- Select Tenant --</option>
                                    </select>
                                    <span asp-validation-for="LeaseInput.UserId" class="text-danger small"></span>
                                </div>
                                <div class="mb-0">
                                    <label class="form-label fw-semibold">
                                        <i class="bi bi-info-circle me-1"></i>Tenant Email
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="tenantEmailDisplay" 
                                           readonly 
                                           placeholder="Select a tenant to view email"
                                           style="background-color: #f8f9fa;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Apartment Information Section -->
                    <div class="mb-4">
                        <div class="card border-0 shadow-sm" style="border-radius: 8px;">
                            <div class="card-header bg-success text-white" style="border-radius: 8px 8px 0 0; padding: 0.75rem 1rem;">
                                <h6 class="mb-0 fw-semibold">
                                    <i class="bi bi-house-door-fill me-2"></i>Apartment Information
                                </h6>
                            </div>
                            <div class="card-body p-3">
                                <div class="mb-3">
                                    <label asp-for="LeaseInput.ApartmentId" class="form-label fw-semibold">
                                        <i class="bi bi-building me-1"></i>Select Apartment
                                    </label>
                                    <select asp-for="LeaseInput.ApartmentId" 
                                            asp-items="Model.AvailableApartments" 
                                            class="form-select" 
                                            id="apartmentSelect"
                                            required>
                                        <option value="">-- Select Apartment --</option>
                                    </select>
                                    <span asp-validation-for="LeaseInput.ApartmentId" class="text-danger small"></span>
                                </div>
                                <div class="mb-0">
                                    <label class="form-label fw-semibold">
                                        <i class="bi bi-info-circle me-1"></i>Apartment Status
                                    </label>
                                    <input type="text" 
                                           class="form-control" 
                                           id="apartmentStatusDisplay" 
                                           readonly 
                                           placeholder="Select an apartment to view status"
                                           style="background-color: #f8f9fa;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Lease Details -->
                    <div class="row mb-3">
                        <div class="col-md-6 mb-3">
                            <label asp-for="LeaseInput.LeaseStart" class="form-label fw-semibold">
                                <i class="bi bi-calendar-event me-1"></i>Lease Start Date
                            </label>
                            <input asp-for="LeaseInput.LeaseStart" 
                                   type="date" 
                                   class="form-control" 
                                   required />
                            <span asp-validation-for="LeaseInput.LeaseStart" class="text-danger small"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="LeaseInput.LeaseEnd" class="form-label fw-semibold">
                                <i class="bi bi-calendar-x me-1"></i>Lease End Date
                            </label>
                            <input asp-for="LeaseInput.LeaseEnd" 
                                   type="date" 
                                   class="form-control" 
                                   required />
                            <span asp-validation-for="LeaseInput.LeaseEnd" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-md-6 mb-3">
                            <label asp-for="LeaseInput.MonthlyRent" class="form-label fw-semibold">
                                <i class="bi bi-currency-dollar me-1"></i>Monthly Rent
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">₱</span>
                                <input asp-for="LeaseInput.MonthlyRent" 
                                       type="number" 
                                       step="0.01" 
                                       min="0" 
                                       class="form-control" 
                                       placeholder="0.00"
                                       required />
                            </div>
                            <span asp-validation-for="LeaseInput.MonthlyRent" class="text-danger small"></span>
                        </div>
                        <div class="col-md-6 mb-3">
                            <label asp-for="LeaseInput.SecurityDeposit" class="form-label fw-semibold">
                                <i class="bi bi-shield-check me-1"></i>Security Deposit
                            </label>
                            <div class="input-group">
                                <span class="input-group-text">₱</span>
                                <input asp-for="LeaseInput.SecurityDeposit" 
                                       type="number" 
                                       step="0.01" 
                                       min="0" 
                                       class="form-control" 
                                       placeholder="0.00"
                                       required />
                            </div>
                            <span asp-validation-for="LeaseInput.SecurityDeposit" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label fw-semibold">
                            <i class="bi bi-info-circle me-1"></i>Lease Status
                        </label>
                        <input type="text" 
                               class="form-control" 
                               id="leaseStatusDisplay" 
                               readonly 
                               placeholder="Calculated based on dates"
                               style="background-color: #f8f9fa;">
                    </div>
                </div>
                <div class="modal-footer" style="border-top: 1px solid #e0e0e0;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-success" id="saveLeaseBtn">
                        <i class="bi bi-check-circle me-2"></i>Save Lease
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Lease Modal -->
<div class="modal fade" id="deleteLeaseModal" tabindex="-1" aria-labelledby="deleteLeaseModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content" style="border-radius: 12px;">
            <div class="modal-header bg-danger text-white" style="border-radius: 12px 12px 0 0;">
                <h5 class="modal-title fw-bold" id="deleteLeaseModalLabel">
                    <i class="bi bi-exclamation-triangle me-2"></i>Delete Lease
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form method="post" asp-page-handler="DeleteLease">
                <div class="modal-body p-4">
                    <input type="hidden" id="deleteLeaseId" name="id" />
                    <div class="text-center">
                        <i class="bi bi-exclamation-triangle text-danger" style="font-size: 3rem;"></i>
                        <h5 class="mt-3">Are you sure you want to delete this lease?</h5>
                        <p class="text-muted">This action cannot be undone.</p>
                        <div class="alert alert-warning">
                            <strong>Tenant:</strong> <span id="deleteTenantName"></span><br>
                            <strong>Unit:</strong> <span id="deleteUnitNumber"></span>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="bi bi-trash me-2"></i>Delete Lease
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        // Reset form when creating new lease
        function resetLeaseForm() {
            const form = document.getElementById('leaseForm');
            form.action = '?handler=CreateLease';
            document.getElementById('modalTitle').textContent = 'CREATE NEW LEASE';
            document.getElementById('leaseId').value = '0';
            form.reset();
            document.getElementById('tenantEmailDisplay').value = '';
            document.getElementById('apartmentStatusDisplay').value = '';
            document.getElementById('leaseStatusDisplay').value = '';
            document.getElementById('saveLeaseBtn').innerHTML = '<i class="bi bi-check-circle me-2"></i>Save Lease';
        }

        // Load lease data for editing
        async function loadLeaseForEdit(leaseId) {
            try {
                const response = await fetch(`?handler=LeaseDetails&id=${leaseId}`);
                const data = await response.json();
                
                if (data.error) {
                    alert(data.error);
                    return;
                }

                const form = document.getElementById('leaseForm');
                form.action = '?handler=EditLease';
                document.getElementById('modalTitle').textContent = 'EDIT LEASE';
                document.getElementById('leaseId').value = data.id;
                document.getElementById('tenantSelect').value = data.userId;
                document.getElementById('apartmentSelect').value = data.apartmentId;
                document.getElementById('LeaseInput_LeaseStart').value = data.leaseStart;
                document.getElementById('LeaseInput_LeaseEnd').value = data.leaseEnd;
                document.getElementById('LeaseInput_MonthlyRent').value = data.monthlyRent;
                document.getElementById('LeaseInput_SecurityDeposit').value = data.securityDeposit;
                document.getElementById('leaseStatusDisplay').value = data.status;
                document.getElementById('saveLeaseBtn').innerHTML = '<i class="bi bi-check-circle me-2"></i>Update Lease';

                // Update tenant email display
                updateTenantEmail();
                // Update apartment status display
                updateApartmentStatus();
            } catch (error) {
                console.error('Error loading lease:', error);
                alert('Error loading lease details.');
            }
        }

        // Update tenant email when tenant is selected
        document.getElementById('tenantSelect')?.addEventListener('change', updateTenantEmail);
        function updateTenantEmail() {
            const select = document.getElementById('tenantSelect');
            const selectedOption = select.options[select.selectedIndex];
            const emailDisplay = document.getElementById('tenantEmailDisplay');
            
            if (selectedOption && selectedOption.value) {
                // Extract email from option text (format: "Name (email)")
                const text = selectedOption.text;
                const emailMatch = text.match(/\(([^)]+)\)/);
                if (emailMatch) {
                    emailDisplay.value = emailMatch[1];
                } else {
                    emailDisplay.value = selectedOption.text;
                }
            } else {
                emailDisplay.value = '';
            }
        }

        // Update apartment status when apartment is selected
        document.getElementById('apartmentSelect')?.addEventListener('change', updateApartmentStatus);
        function updateApartmentStatus() {
            const select = document.getElementById('apartmentSelect');
            const selectedOption = select.options[select.selectedIndex];
            const statusDisplay = document.getElementById('apartmentStatusDisplay');
            
            if (selectedOption && selectedOption.value) {
                // Check if text contains "(Occupied)"
                const text = selectedOption.text;
                if (text.includes('(Occupied)')) {
                    statusDisplay.value = 'Occupied';
                } else {
                    statusDisplay.value = 'Available';
                }
            } else {
                statusDisplay.value = '';
            }
        }

        // Update lease status based on dates
        document.getElementById('LeaseInput_LeaseStart')?.addEventListener('change', updateLeaseStatus);
        document.getElementById('LeaseInput_LeaseEnd')?.addEventListener('change', updateLeaseStatus);
        function updateLeaseStatus() {
            const startDate = new Date(document.getElementById('LeaseInput_LeaseStart').value);
            const endDate = new Date(document.getElementById('LeaseInput_LeaseEnd').value);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const statusDisplay = document.getElementById('leaseStatusDisplay');
            
            if (!startDate || !endDate || isNaN(startDate.getTime()) || isNaN(endDate.getTime())) {
                statusDisplay.value = '';
                return;
            }
            
            if (today < startDate) {
                statusDisplay.value = 'Upcoming';
            } else if (today >= startDate && today <= endDate) {
                statusDisplay.value = 'Active';
            } else {
                statusDisplay.value = 'Expired';
            }
        }

        // Delete modal handler
        document.getElementById('deleteLeaseModal')?.addEventListener('show.bs.modal', function (event) {
            const button = event.relatedTarget;
            const leaseId = button.getAttribute('data-lease-id');
            const tenantName = button.getAttribute('data-tenant-name');
            const unitNumber = button.getAttribute('data-unit-number');

            document.getElementById('deleteLeaseId').value = leaseId;
            document.getElementById('deleteTenantName').textContent = tenantName;
            document.getElementById('deleteUnitNumber').textContent = unitNumber;
        });

        // Set form action based on whether it's create or edit
        document.getElementById('leaseForm')?.addEventListener('submit', function(e) {
            const leaseId = document.getElementById('leaseId').value;
            const form = this;
            
            // Set the correct handler based on lease ID
            if (leaseId && leaseId !== '0') {
                form.action = '?handler=EditLease';
            } else {
                form.action = '?handler=CreateLease';
            }
        });
    </script>
}

