@page "/Admin/ManageTenants"
@model Apartment.Pages.Admin.ManageTenantsModel
@using System.Globalization
@{
    // Determine which view to show based on the handler parameter
    var handler = Request.Query["handler"].ToString().ToLower();
    var hasId = !string.IsNullOrEmpty(Request.Query["id"].ToString());
    
    // Determine view based on handler - Read-only, only Details view
    var isDetails = handler == "details";
    
    // Default to Index if no specific handler
    if (string.IsNullOrEmpty(handler) && !isDetails)
    {
        ViewData["Title"] = "Tenant Management (Read-Only)";
    }
    Layout = "_Layout";
    var pesoCulture = CultureInfo.CreateSpecificCulture("en-PH");
}

<div class="d-flex">
    @await Html.PartialAsync("_AdminSidebar")

    <!-- Main Content -->
    <div class="main-content" style="margin-left: 280px; width: calc(100% - 280px); padding: 2rem;">

@* INDEX VIEW - Tenant List (Read-Only) *@
@if (!isDetails)
{
    <div class="container-fluid">
        <!-- Modern Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center gap-3 flex-wrap">
                    <h1 class="display-5 fw-bold text-primary mb-0">
                        <i class="bi bi-people me-3"></i>Tenant Management (Read-Only)
                    </h1>
                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle me-2"></i>
                        <small>Tenants are automatically shown here when created with Tenant role. Use <a asp-page="/Admin/ManageUsers">Manage Users</a> to create new tenant accounts.</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Success/Error Messages -->
        @if (!string.IsNullOrEmpty(Model.SuccessMessage))
        {
            <div class="alert alert-success alert-dismissible fade show" role="alert" data-auto-toast="true">
                <i class="bi bi-check-circle me-2"></i>
                @Model.SuccessMessage
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        @if (!string.IsNullOrEmpty(Model.ErrorMessage))
        {
            <div class="alert alert-danger alert-dismissible fade show" role="alert" data-auto-toast="true">
                <i class="bi bi-exclamation-triangle me-2"></i>
                @Model.ErrorMessage
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
        }

        <!-- Modern Table Card -->
        <div class="card shadow-lg rounded-4 border-0">
            <div class="card-header bg-light border-0 py-3">
                <h5 class="card-title mb-0 text-dark fw-semibold">
                    <i class="bi bi-list-ul me-2"></i>Tenants (@Model.Tenants.Count)
                </h5>
            </div>
            <div class="card-body p-0">
                @if (Model.Tenants.Any())
                {
                    <div class="table-responsive">
                        <table class="table table-hover table-striped mb-0 data-table">
                            <thead class="table-primary">
                                <tr>
                                    <th class="fw-semibold">Full Name</th>
                                    <th class="fw-semibold">Email</th>
                                    <th class="fw-semibold">Phone</th>
                                    <th class="fw-semibold">Monthly Rent</th>
                                    <th class="fw-semibold">Status</th>
                                    <th class="fw-semibold">Assigned Unit</th>
                                    <th class="fw-semibold text-center">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var tenant in Model.Tenants)
                                {
                                    <tr>
                                        <td class="fw-medium">@tenant.FullName</td>
                                        <td>@tenant.PrimaryEmail</td>
                                        <td>@tenant.PrimaryPhone</td>
                                        <td class="text-success fw-semibold">@tenant.MonthlyRent.ToString("C", pesoCulture)</td>
                                        <td>
                                            <span class="badge bg-info fs-6">@tenant.LeaseStatus</span>
                                        </td>
                                        <td>
                                            @if (tenant.AssignedUnit == "Unassigned")
                                            {
                                                <span class="badge bg-secondary fs-6">@tenant.AssignedUnit</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-primary fs-6">@tenant.AssignedUnit</span>
                                            }
                                        </td>
                                        <td class="text-center">
                                            <a asp-page="/Admin/ManageTenants" asp-page-handler="Details" asp-route-id="@tenant.Id" class="btn btn-outline-info btn-sm" title="View Details">
                                                <i class="bi bi-eye"></i> View
                                            </a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="empty-state-card">
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="bi bi-people"></i>
                            </div>
                            <h3 class="empty-state-title">No Tenants Found</h3>
                            <p class="empty-state-message">
                                You haven't added any tenants yet. Start by adding your first tenant to the system.
                            </p>
                            <div class="empty-state-action">
                                <a asp-page="/Admin/ManageTenants" asp-page-handler="Create" class="btn btn-primary">
                                    <i class="bi bi-plus-circle me-2"></i>Add First Tenant
                                </a>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>

    @section Scripts {
        <script>
            // Auto-dismiss alerts after 5 seconds
            setTimeout(function() {
                const alerts = document.querySelectorAll('.alert');
                alerts.forEach(function(alert) {
                    const bsAlert = new bootstrap.Alert(alert);
                    bsAlert.close();
                });
            }, 5000);

            function confirmDeleteTenant(tenantName, tenantId) {
                showAlert.delete('Delete Tenant', `Are you sure you want to delete tenant '<strong>${tenantName}</strong>'? This action cannot be undone.`)
                    .then((result) => {
                        if (result) {
                            document.getElementById(`deleteTenantForm_${tenantId}`).submit();
                        }
                    });
            }
        </script>
    }
}

@* DETAILS VIEW - Single Tenant View (Read-Only) *@
@if (isDetails && Model.UserDetails != null)
{
    ViewData["Title"] = "Tenant Details (Read-Only)";
    
    <div class="container-fluid">
        <!-- Header Section -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="d-flex justify-content-between align-items-center">
                    <h1 class="display-5 fw-bold text-primary mb-0">
                        <i class="bi bi-person-circle me-3"></i>Tenant Details (Read-Only)
                    </h1>
                    <div class="d-flex gap-2">
                        <a asp-page="/Admin/ManageUsers" asp-page-handler="Edit" asp-route-id="@Model.UserDetails.Id" class="btn btn-primary">
                            <i class="bi bi-pencil-square me-2"></i>Edit User
                        </a>
                        <a asp-page="/Admin/ManageTenants" class="btn btn-outline-secondary">
                            <i class="bi bi-arrow-left me-2"></i>Back to List
                        </a>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <!-- Personal Information Card -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow-lg border-0 h-100">
                    <div class="card-header bg-primary text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-person me-2"></i>Personal Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-4 fw-semibold">Username</dt>
                            <dd class="col-sm-8">@Model.UserDetails.Username</dd>

                            <dt class="col-sm-4 fw-semibold">Email</dt>
                            <dd class="col-sm-8">@Model.UserDetails.Email</dd>

                            <dt class="col-sm-4 fw-semibold">Role</dt>
                            <dd class="col-sm-8">
                                <span class="badge bg-info fs-6">@Model.UserDetails.Role</span>
                            </dd>

                            <dt class="col-sm-4 fw-semibold">Status</dt>
                            <dd class="col-sm-8">
                                <span class="badge bg-info fs-6">@(Model.UserDetails.Status ?? "Not Set")</span>
                            </dd>
                        </dl>
                    </div>
                </div>
            </div>

            <!-- Lease & Unit Information Card -->
            <div class="col-lg-6 mb-4">
                <div class="card shadow-lg border-0 h-100">
                    <div class="card-header bg-success text-white">
                        <h5 class="mb-0">
                            <i class="bi bi-file-earmark-text me-2"></i>Lease & Unit Information
                        </h5>
                    </div>
                    <div class="card-body">
                        <dl class="row mb-0">
                            <dt class="col-sm-4 fw-semibold">Monthly Rent</dt>
                            <dd class="col-sm-8 text-success fw-semibold">@(Model.ActiveLease?.MonthlyRent.ToString("C", pesoCulture) ?? "N/A")</dd>

                            @if (Model.ActiveLease != null)
                            {
                                <dt class="col-sm-4 fw-semibold">Lease Start</dt>
                                <dd class="col-sm-8">@Model.ActiveLease.LeaseStart.ToString("MMM dd, yyyy")</dd>

                                <dt class="col-sm-4 fw-semibold">Lease End</dt>
                                <dd class="col-sm-8">@Model.ActiveLease.LeaseEnd.ToString("MMM dd, yyyy")</dd>
                            }

                            <dt class="col-sm-4 fw-semibold">Assigned Apartment</dt>
                            <dd class="col-sm-8">
                                @if (!string.IsNullOrEmpty(Model.ActiveLease?.UnitNumber))
                                {
                                    <span class="badge bg-primary fs-6">@Model.ActiveLease.UnitNumber</span>
                                }
                                else
                                {
                                    <span class="badge bg-secondary fs-6">Unassigned</span>
                                }
                            </dd>

                            <dt class="col-sm-4 fw-semibold">Created At</dt>
                            <dd class="col-sm-8">@Model.UserDetails.CreatedAt.ToString("MMM dd, yyyy HH:mm")</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>
}
else if (isDetails)
{
    <div class="container-fluid">
        <div class="alert alert-warning no-toast">
            <i class="bi bi-exclamation-triangle me-2"></i>Tenant user not found.
        </div>
    </div>
}

@* CREATE, EDIT, and DELETE views removed - Tenant Management is now read-only *@
    </div>
</div>

<style>
    .main-content {
        min-height: 100vh;
        background: #f8f9fa;
    }
</style>
