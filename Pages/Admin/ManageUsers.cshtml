@page "/Admin/ManageUsers"
@using Apartment.ViewModels
@using Apartment.Enums
@model Apartment.Pages.Admin.ManageUsersModel
@{
    ViewData["Title"] = "User Management";
    Layout = "_Layout";
}

<div class="d-flex">
    @await Html.PartialAsync("_AdminSidebar")

    <!-- Main Content -->
    <div class="main-content users-main">
        <div class="container-fluid">
            @* Standardized Messages *@
            @{
                ViewData["SuccessMessage"] = Model.SuccessMessage;
                ViewData["ErrorMessage"] = Model.ErrorMessage;
            }
            @await Html.PartialAsync("_MessagePartial")

            <!-- Page Header -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="users-header card border-0 shadow-sm">
                        <div class="card-body d-flex justify-content-between align-items-start flex-wrap gap-3">
                            <div>
                                <h2 class="users-title mb-1">
                                    <i class="bi bi-people me-2"></i>User Management
                                </h2>
                                <p class="users-subtitle mb-0">Manage system account users and roles.</p>
                            </div>
                            <button type="button" class="btn btn-add-user" data-bs-toggle="modal" data-bs-target="#addUserModal">
                                <i class="bi bi-person-plus me-2"></i>Add User
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search and Filter Row -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-0 shadow-sm users-filter-card">
                        <div class="card-body p-3 p-lg-4">
                            <form method="get" class="row g-3 align-items-end">
                                <div class="col-md-4">
                                    <label class="form-label small text-muted mb-1">Search</label>
                                    <div class="input-group users-search-input">
                                        <span class="input-group-text bg-white border-end-0">
                                            <i class="bi bi-search text-muted"></i>
                                        </span>
                                        <input type="text" 
                                               class="form-control border-start-0" 
                                               placeholder="Search users..." 
                                               name="SearchTerm" 
                                               value="@Model.SearchTerm" />
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small text-muted mb-1">Role</label>
                                    <select class="form-select users-select" name="RoleFilter">
                                        <option value="All" selected="@(Model.RoleFilter == null || Model.RoleFilter == "All")">All</option>
                                        <option value="Admin" selected="@(Model.RoleFilter == "Admin")">Admin</option>
                                        <option value="Tenant" selected="@(Model.RoleFilter == "Tenant")">User</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <label class="form-label small text-muted mb-1">Status</label>
                                    <select class="form-select users-select" name="StatusFilter">
                                        <option value="All" selected="@(Model.StatusFilter == null || Model.StatusFilter == "All")">All</option>
                                        <option value="Active" selected="@(Model.StatusFilter == "Active")">Active</option>
                                        <option value="Inactive" selected="@(Model.StatusFilter == "Inactive")">Inactive</option>
                                    </select>
                                </div>
                                <div class="col-md-2">
                                    <button type="submit" class="btn btn-search w-100">
                                        <i class="bi bi-filter me-1"></i>Apply
                                    </button>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Users Table -->
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-0 shadow-sm users-table-card">
                        <div class="card-body p-0">
                            @if (Model.Users.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-hover mb-0 data-table users-table" id="usersTable">
                                        <thead class="users-table-head">
                                            <tr>
                                                <th class="border-0 ps-4 users-th">Username</th>
                                                <th class="border-0 users-th">Email</th>
                                                <th class="border-0 users-th">Role</th>
                                                <th class="border-0 users-th">Status</th>
                                                <th class="border-0 users-th">Created</th>
                                                <th class="border-0 users-th">Last Login</th>
                                                <th class="border-0 text-center pe-4 users-th">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var user in Model.Users)
                                            {
                                                <tr class="user-row" data-user-id="@user.Id" onclick="openUserDrawer(@user.Id, '@user.Username', '@user.Email', '@user.Role', '@(user.Status ?? "Active")', '@user.CreationDate.ToString("MMM dd, yyyy")', '@(user.LastLogin?.ToString("HH:mm") ?? "Never")', '@user.CreationDate.ToString("MMM dd, yyyy")', '@(user.LastLogin?.ToString("MMM dd, yyyy HH:mm") ?? "Never")', @(user.Role == UserRoles.Admin ? "true" : "false"))">
                                                    <td class="align-middle ps-4">
                                                        <div class="fw-semibold users-username">@user.Username</div>
                                                    </td>
                                                    <td class="align-middle">
                                                        <span class="text-truncate d-inline-block users-email" title="@user.Email">
                                                            @user.Email
                                                        </span>
                                                    </td>
                                                    <td class="align-middle">
                                                        @{
                                                            var roleBadgeClass = user.Role switch
                                                            {
                                                                UserRoles.Admin => "badge-gold",
                                                                UserRoles.Tenant => "badge-green",
                                                                _ => "badge-secondary"
                                                            };
                                                        }
                                                        <span class="badge @roleBadgeClass">
                                                            @user.Role
                                                        </span>
                                                    </td>
                                                    <td class="align-middle">
                                                        @{
                                                            var statusBadgeClass = (user.Status?.ToLower() == "active" || user.Status == null) ? "badge-green" : "badge-gray";
                                                            var statusText = (user.Status?.ToLower() == "active" || user.Status == null) ? "Active" : "Inactive";
                                                        }
                                                        <span class="badge @statusBadgeClass">
                                                            @statusText
                                                        </span>
                                                    </td>
                                                    <td class="align-middle">
                                                        <div class="text-muted small users-mono">@user.CreationDate.ToString("MMM dd")</div>
                                                    </td>
                                                    <td class="align-middle">
                                                        <div class="text-muted small users-mono">@(user.LastLogin?.ToString("HH:mm") ?? "Never")</div>
                                                    </td>
                                                    <td class="align-middle text-center pe-4">
                                                        <div class="dropdown" onclick="event.stopPropagation();">
                                                            <button class="btn btn-sm btn-link text-muted p-0" type="button" data-bs-toggle="dropdown" aria-expanded="false">
                                                                <i class="bi bi-three-dots-vertical" style="font-size: 1.2rem;"></i>
                                                            </button>
                                                            <ul class="dropdown-menu dropdown-menu-end shadow-sm" style="border-radius: 8px; border: none;" onclick="event.stopPropagation();">
                                                                <li>
                                                                    <a class="dropdown-item" href="#" onclick="event.stopPropagation(); openUserDrawer(@user.Id, '@user.Username', '@user.Email', '@user.Role', '@(user.Status ?? "Active")', '@user.CreationDate.ToString("MMM dd, yyyy")', '@(user.LastLogin?.ToString("HH:mm") ?? "Never")', '@user.CreationDate.ToString("MMM dd, yyyy")', '@(user.LastLogin?.ToString("MMM dd, yyyy HH:mm") ?? "Never")', @(user.Role == UserRoles.Admin ? "true" : "false")); return false;">
                                                                        <i class="bi bi-eye me-2"></i>View Profile
                                                                    </a>
                                                                </li>
                                                                @if (user.Role != UserRoles.Admin)
                                                                {
                                                                    <li><hr class="dropdown-divider"></li>
                                                                    <li>
                                                                        <a class="dropdown-item text-danger" href="#" onclick="event.stopPropagation(); confirmDeleteUser('@user.Username', @user.Id); return false;">
                                                                            <i class="bi bi-trash me-2"></i>Delete
                                                                        </a>
                                                                    </li>
                                                                }
                                                            </ul>
                                                        </div>
                                                    </td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                @* Standardized Empty State *@
                                ViewData["EmptyIcon"] = "bi-person-x";
                                ViewData["EmptyTitle"] = "No Users Found";
                                ViewData["EmptyMessage"] = !string.IsNullOrEmpty(Model.SearchTerm) 
                                    ? "No users match your search criteria. Try adjusting your search terms." 
                                    : "There are no users in the system yet.";
                                @await Html.PartialAsync("_EmptyStatePartial")
                            }
                        </div>
                    </div>
                </div>
            </div>

            <!-- Stats Cards -->
            <div class="row">
                <div class="col-md-6 mb-3">
                    <div class="card border-0 shadow-sm stats-card stats-card-mint">
                        <div class="card-body text-center text-white p-4">
                            <div class="display-6 mb-2">
                                <i class="bi bi-people-fill"></i>
                            </div>
                            <h3 class="mb-1 stats-value">@Model.Users.Count</h3>
                            <small class="stats-label">Total Users</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-6 mb-3">
                    <div class="card border-0 shadow-sm stats-card stats-card-mint">
                        <div class="card-body text-center text-white p-4">
                            <div class="display-6 mb-2">
                                <i class="bi bi-check-circle-fill"></i>
                            </div>
                            <h3 class="mb-1 stats-value">@Model.Users.Count(u => u.Status?.ToLower() == "active" || u.Status == null)</h3>
                            <small class="stats-label">Active Users</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<div class="modal fade" id="addUserModal" tabindex="-1" aria-labelledby="addUserModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered" style="border-radius: 12px;">
        <div class="modal-content border-0 shadow-lg" style="border-radius: 12px;">
            <div class="modal-header border-0 pb-0" style="padding: 1.5rem 1.5rem 0.5rem;">
                <h5 class="modal-title" id="addUserModalLabel" style="font-weight: 600;">Add New User</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body px-4 pb-4">
                <form method="post" asp-page-handler="AddUser" id="addUserForm">
                    <div class="mb-3">
                        <label asp-for="NewUser.Username" class="form-label small text-muted mb-1">Username</label>
                        <input type="text" asp-for="NewUser.Username" class="form-control" style="border-radius: 8px;" placeholder="Enter username" />
                        <span asp-validation-for="NewUser.Username" class="text-danger small"></span>
                    </div>
                    <div class="mb-3">
                        <label asp-for="NewUser.Email" class="form-label small text-muted mb-1">Email</label>
                        <input type="email" asp-for="NewUser.Email" class="form-control" style="border-radius: 8px;" placeholder="Enter email address" />
                        <span asp-validation-for="NewUser.Email" class="text-danger small"></span>
                    </div>
                    <div class="alert alert-info small mb-0" style="border-radius: 8px; background-color: #e8f4f8; border-color: #bee5eb;">
                        <i class="bi bi-info-circle me-2"></i>A temporary password will be generated and sent via email.
                    </div>
                </form>
            </div>
            <div class="modal-footer border-0 pt-0" style="padding: 0.5rem 1.5rem 1.5rem;">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal" style="border-radius: 8px;">Cancel</button>
                <button type="submit" form="addUserForm" class="btn btn-add-user" style="border-radius: 8px;">
                    <i class="bi bi-plus-circle me-1"></i>Add User
                </button>
            </div>
        </div>
    </div>
</div>

<!-- User Profile Drawer -->
<div class="user-drawer" id="userDrawer">
    <div class="drawer-overlay" onclick="closeUserDrawer()"></div>
    <div class="drawer-content">
        <div class="drawer-header">
            <h5 class="mb-0" style="font-weight: 600;">User Profile</h5>
            <button type="button" class="btn-close" onclick="closeUserDrawer()" aria-label="Close"></button>
        </div>
        <div class="drawer-body">
            <div class="mb-4">
                <label class="form-label small text-muted mb-1">Name</label>
                <div class="fw-semibold" id="drawerUsername" style="color: #202124; font-size: 1.1rem;"></div>
            </div>
            <div class="mb-4">
                <label class="form-label small text-muted mb-1">Email</label>
                <div id="drawerEmail" style="color: #5f6368;"></div>
            </div>
            <div class="mb-4">
                <label class="form-label small text-muted mb-1">Role</label>
                <div id="drawerRole"></div>
            </div>
            <div class="mb-4">
                <label class="form-label small text-muted mb-1">Status</label>
                <div id="drawerStatus"></div>
            </div>
            <div class="mb-4">
                <label class="form-label small text-muted mb-1">Created</label>
                <div id="drawerCreated" style="color: #5f6368;"></div>
            </div>
            <div class="mb-4">
                <label class="form-label small text-muted mb-1">Last Login</label>
                <div id="drawerLastLogin" style="color: #5f6368;"></div>
            </div>
            <hr class="my-4">
            <div class="d-grid gap-2" id="drawerActions">
                <form method="post" asp-page-handler="ResetPassword" class="d-inline" id="resetPasswordForm">
                    <input type="hidden" name="userId" id="resetPasswordUserId" />
                    <button type="button" class="btn btn-outline-primary w-100 mb-2" style="border-radius: 8px;" onclick="confirmResetPassword()">
                        <i class="bi bi-lock me-2"></i>Reset Password
                    </button>
                </form>
                <form method="post" asp-page-handler="ToggleStatus" class="d-inline" id="toggleStatusForm" style="display: none;">
                    <input type="hidden" name="userId" id="toggleStatusUserId" />
                    <button type="button" class="btn btn-outline-secondary w-100" style="border-radius: 8px;" onclick="confirmToggleStatus()">
                        <i class="bi bi-toggle-on me-2" id="toggleStatusIcon"></i><span id="toggleStatusText">Activate/Deactivate</span>
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>

<!-- Hidden Delete Form -->
<form method="post" asp-page-handler="DeleteUser" id="deleteUserForm" style="display: none;">
    <input type="hidden" name="userId" id="deleteUserFormUserId" />
</form>


<style>
    /* Page layout */
    .users-main {
        margin-left: 280px;
        width: calc(100% - 280px);
        padding: 2rem;
        min-height: 100vh;
        background: #F8F9FA; /* Chalk White */
    }

    .users-header {
        border-radius: 12px;
        background: #FFFFFF;
        border-left: 3px solid #F4C95D; /* Golden Ratio Gold accent */
    }

    .users-title {
        font-weight: 700;
        color: #1B2E4A; /* Deep Theorem Blue */
    }

    .users-subtitle {
        font-size: 0.95rem;
        color: #888888; /* Medium Slate */
    }

    /* Modern Button Styles */
    .btn-add-user {
        background-color: #3FA585; /* Equation Emerald */
        border: none;
        color: white;
        font-weight: 500;
        padding: 0.6rem 1.5rem;
        border-radius: 8px;
        transition: all 0.2s ease;
    }

    .btn-add-user:hover {
        background-color: #358a70;
        color: white;
        transform: translateY(-1px);
        box-shadow: 0 4px 12px rgba(63, 165, 133, 0.3);
    }

    .btn-search {
        background-color: #3FA585;
        border: none;
        color: white;
        font-weight: 500;
        transition: all 0.2s ease;
    }

    .btn-search:hover {
        background-color: #358a70;
        color: white;
    }

    /* Badge Styles */
    .badge-green {
        background-color: #3FA585;
        color: white;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-weight: 500;
        font-size: 0.8rem;
    }

    .badge-gold {
        background-color: #F4C95D;
        color: white;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-weight: 500;
        font-size: 0.8rem;
    }

    .badge-gray {
        background-color: #9e9e9e;
        color: white;
        padding: 0.35rem 0.75rem;
        border-radius: 20px;
        font-weight: 500;
        font-size: 0.8rem;
    }

    /* Table Styles */
    .table {
        border-collapse: separate;
        border-spacing: 0;
    }

    .table tbody tr {
        transition: background-color 0.2s ease;
    }

    .users-table-head {
        background-color: #1B2E4A; /* Deep Theorem Blue */
        color: #F8F9FA;
        border-bottom: 2px solid #E6E6E6;
    }

    .users-th {
        font-weight: 600;
        font-size: 0.875rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        color: #F8F9FA;
    }

    .users-table-card {
        border-radius: 12px;
        overflow: hidden;
    }

    .users-table tbody tr {
        transition: background-color 0.2s ease;
    }

    .users-table tbody tr:nth-child(even) {
        background-color: #C9F1E7; /* Graph Paper Mint */
    }

    .users-table tbody tr:hover {
        background-color: #E3FBF3;
    }

    .table td {
        border-top: 1px solid #E6E6E6;
        padding: 1rem 0.75rem;
    }

    .user-row {
        cursor: pointer;
    }

    .users-username {
        color: #1B2E4A;
    }

    .users-email {
        max-width: 250px;
        color: #5f6368;
    }

    .users-mono {
        font-family: 'JetBrains Mono', Consolas, monospace;
    }

    .users-filter-card {
        border-radius: 12px;
        background: #FFFFFF;
        border: 1px solid #E6E6E6;
    }

    .users-search-input .input-group-text {
        border-radius: 8px 0 0 8px;
        border-color: #E6E6E6;
    }

    .users-search-input .form-control {
        border-radius: 0 8px 8px 0;
        border-color: #E6E6E6;
    }

    .users-select {
        border-radius: 8px;
        border-color: #E6E6E6;
    }

    /* Stats Card Hover Effect */
    .stats-card {
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .stats-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 16px rgba(0, 0, 0, 0.1) !important;
    }

    .stats-card-mint {
        border-radius: 12px;
        background: linear-gradient(135deg, #3FA585 0%, #1B2E4A 100%);
    }

    .stats-value {
        font-weight: 700;
        font-size: 2.5rem;
    }

    .stats-label {
        font-size: 0.9rem;
        opacity: 0.95;
    }

    /* Drawer Styles */
    .user-drawer {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: 1050;
    }

    .user-drawer.active {
        display: flex;
    }

    .drawer-overlay {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        backdrop-filter: blur(2px);
    }

    .drawer-content {
        position: absolute;
        top: 0;
        right: 0;
        width: 400px;
        height: 100%;
        background-color: white;
        box-shadow: -4px 0 16px rgba(0, 0, 0, 0.1);
        display: flex;
        flex-direction: column;
        z-index: 1051;
        animation: slideIn 0.3s ease;
    }

    @@keyframes slideIn {
        from {
            transform: translateX(100%);
        }
        to {
            transform: translateX(0);
        }
    }

    .drawer-header {
        padding: 1.5rem;
        border-bottom: 1px solid #f1f3f4;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .drawer-body {
        padding: 1.5rem;
        overflow-y: auto;
        flex: 1;
    }

    /* Card Shadows */
    .card {
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06) !important;
        transition: box-shadow 0.2s ease;
    }

    .card:hover {
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.10) !important;
    }

    /* Dropdown Menu */
    .dropdown-menu {
        border-radius: 8px;
        border: 1px solid #e0e0e0;
        padding: 0.5rem;
    }

    .dropdown-item {
        border-radius: 6px;
        padding: 0.5rem 0.75rem;
        transition: background-color 0.2s ease;
    }

    .dropdown-item:hover {
        background-color: #f8f9fa;
    }

    /* DataTables Controls Alignment */
    #usersTable_wrapper .dataTables_length {
        padding-left: 1rem;
    }

    #usersTable_wrapper .dataTables_length label {
        margin-bottom: 0;
    }

    #usersTable_wrapper .dataTables_info {
        padding-left: 1rem;
    }

    #usersTable_wrapper .dataTables_filter {
        padding-right: 1rem;
    }
</style>

@section Scripts {
    <script>
        let currentUserId = null;
        let currentUserStatus = null;
        let currentUserIsAdmin = false;

        // Open user drawer
        function openUserDrawer(userId, username, email, role, status, createdShort, lastLoginShort, createdFull, lastLoginFull, isAdmin) {
            currentUserId = userId;
            currentUserStatus = status;
            currentUserIsAdmin = isAdmin === true || isAdmin === 'true';

            document.getElementById('drawerUsername').textContent = username;
            document.getElementById('drawerEmail').textContent = email;
            
            // Set role badge
            const roleBadgeClass = role === 'Admin' ? 'badge-gold' : 'badge-green';
            document.getElementById('drawerRole').innerHTML = `<span class="badge ${roleBadgeClass}">${role}</span>`;
            
            // Set status badge
            const statusBadgeClass = (status.toLowerCase() === 'active') ? 'badge-green' : 'badge-gray';
            const statusText = (status.toLowerCase() === 'active') ? 'Active' : 'Inactive';
            document.getElementById('drawerStatus').innerHTML = `<span class="badge ${statusBadgeClass}">${statusText}</span>`;
            
            document.getElementById('drawerCreated').textContent = createdFull;
            document.getElementById('drawerLastLogin').textContent = lastLoginFull;

            // Set form user IDs
            document.getElementById('resetPasswordUserId').value = userId;
            document.getElementById('toggleStatusUserId').value = userId;

            // Show/hide actions based on user role
            const toggleStatusForm = document.getElementById('toggleStatusForm');
            
            if (currentUserIsAdmin) {
                // Hide Toggle Status for Admin users
                toggleStatusForm.style.display = 'none';
            } else {
                // Show Toggle Status for non-Admin users
                toggleStatusForm.style.display = '';
                
                // Update toggle button text and icon
                const toggleText = document.getElementById('toggleStatusText');
                const toggleIcon = document.getElementById('toggleStatusIcon');
                if (status.toLowerCase() === 'active') {
                    toggleText.textContent = 'Deactivate';
                    toggleIcon.className = 'bi bi-toggle-off me-2';
                } else {
                    toggleText.textContent = 'Activate';
                    toggleIcon.className = 'bi bi-toggle-on me-2';
                }
            }

            // Show drawer
            document.getElementById('userDrawer').classList.add('active');
        }

        // Close user drawer
        function closeUserDrawer() {
            document.getElementById('userDrawer').classList.remove('active');
        }

        // Close drawer on Escape key
        document.addEventListener('keydown', function(event) {
            if (event.key === 'Escape') {
                closeUserDrawer();
            }
        });

        // Confirm reset password
        function confirmResetPassword() {
            const username = document.getElementById('drawerUsername').textContent;
            showAlert.confirm(
                'Reset Password',
                `Are you sure you want to reset the password for <strong>${username}</strong>? A new temporary password will be sent via email.`,
                'Yes, Reset',
                'Cancel'
            ).then((confirmed) => {
                if (confirmed) {
                    document.getElementById('resetPasswordForm').submit();
                }
            });
        }

        // Confirm toggle status
        function confirmToggleStatus() {
            const username = document.getElementById('drawerUsername').textContent;
            const action = currentUserStatus.toLowerCase() === 'active' ? 'deactivate' : 'activate';
            showAlert.confirm(
                `${action.charAt(0).toUpperCase() + action.slice(1)} User`,
                `Are you sure you want to ${action} <strong>${username}</strong>?`,
                `Yes, ${action.charAt(0).toUpperCase() + action.slice(1)}`,
                'Cancel'
            ).then((confirmed) => {
                if (confirmed) {
                    document.getElementById('toggleStatusForm').submit();
                }
            });
        }

        // Delete user confirmation
        function confirmDeleteUser(username, userId) {
            showAlert.delete(
                'Delete User',
                `Are you sure you want to delete user <strong>${username}</strong>? This action cannot be undone!`
            ).then((confirmed) => {
                if (confirmed) {
                    document.getElementById('deleteUserFormUserId').value = userId;
                    document.getElementById('deleteUserForm').submit();
                }
            });
        }
    </script>
}
