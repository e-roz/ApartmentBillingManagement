@page "/Admin/RecordPayments"
@model Apartment.Pages.Admin.RecordPaymentsModel
@{
    ViewData["Title"] = "Payment Processing";
    Layout = "_Layout";
    var pesoCulture = CultureInfo.CreateSpecificCulture("en-PH");
}

<div class="matcha-dashboard d-flex">
    @await Html.PartialAsync("_AdminSidebar")

    <div class="matcha-main">
        <!-- Page Header -->
        <header class="matcha-header d-flex justify-content-between align-items-center flex-wrap gap-3 mb-3">
            <div>
                <h1 class="matcha-h1 mb-1">
                    <i class="bi bi-cash-stack me-2"></i>Payment Processing
                </h1>
                <p class="matcha-subtitle mb-0">
                    Review tenant balances, filter by status, and inspect monthly payment history.
                </p>
            </div>
        </header>

        @* Standardized Messages *@
        @{
            ViewData["SuccessMessage"] = Model.SuccessMessage;
            ViewData["ErrorMessage"] = Model.ErrorMessage;
        }
        @await Html.PartialAsync("_MessagePartial")

        <!-- Filters Section -->
        <section class="matcha-section mb-3">
            <article class="matcha-card matcha-card-soft matcha-card-accent">
                <div class="matcha-card-body">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2 mb-3">
                        <div class="d-flex align-items-center gap-2">
                            <span class="matcha-card-icon matcha-card-icon-payment">
                                <i class="bi bi-funnel"></i>
                            </span>
                            <div>
                                <h2 class="matcha-card-title mb-1">Filter Payments</h2>
                                <p class="matcha-body-s text-muted mb-0">
                                    Narrow down tenants by name, unit, payment status, or month.
                                </p>
                            </div>
                        </div>
                    </div>

                    <form method="get" class="row g-3">
                        <div class="col-md-4 col-lg-3">
                            <label class="form-label small text-muted mb-1">Search Tenant</label>
                            <input type="text" asp-for="SearchTerm" class="form-control" placeholder="Name, Unit, Email..." />
                        </div>
                        <div class="col-md-4 col-lg-3">
                            <label class="form-label small text-muted mb-1">Select Tenant</label>
                            <select asp-for="SelectedTenantUserId" asp-items="Model.TenantOptions" class="form-select">
                            </select>
                        </div>
                        <div class="col-md-2 col-lg-2">
                            <label class="form-label small text-muted mb-1">Status</label>
                            <select asp-for="FilterStatus" asp-items="Model.StatusOptions" class="form-select">
                            </select>
                        </div>
                        <div class="col-md-2 col-lg-2">
                            <label class="form-label small text-muted mb-1">Month</label>
                            <select asp-for="FilterMonth" asp-items="Model.MonthOptions" class="form-select">
                            </select>
                        </div>
                        <div class="col-md-4 col-lg-2 d-flex align-items-end">
                            <button type="submit" class="matcha-btn-primary-light w-100">
                                <i class="bi bi-search me-2"></i>Apply
                            </button>
                        </div>
                    </form>
                </div>
            </article>
        </section>

        <!-- Tenant Payment Summary Panel -->
        @if (Model.SelectedTenantSummary != null)
        {
            <section class="matcha-section mb-3">
                <article class="matcha-card">
                    <div class="matcha-card-header d-flex justify-content-between align-items-center">
                        <div class="d-flex align-items-center gap-2">
                            <span class="matcha-card-icon matcha-card-icon-payment">
                                <i class="bi bi-person-circle"></i>
                            </span>
                            <div>
                                <h2 class="matcha-card-title mb-1">
                                    Payment Summary – @Model.SelectedTenantSummary.TenantName
                                </h2>
                                <p class="matcha-body-s text-muted mb-0">
                                    Unit @Model.SelectedTenantSummary.UnitNumber
                                </p>
                            </div>
                        </div>
                        <div>
                            @{
                                var statusClass = Model.SelectedTenantSummary.PaymentStatus switch
                                {
                                    "Paid" => "matcha-status-chip success",
                                    "Unpaid" => "matcha-status-chip danger",
                                    _ => "matcha-status-chip neutral"
                                };
                            }
                            <span class="@statusClass">
                                <i class="bi bi-circle-fill me-1" style="font-size: 0.55rem;"></i>
                                @Model.SelectedTenantSummary.PaymentStatus
                            </span>
                        </div>
                    </div>
                    <div class="matcha-card-body">
                        <div class="row g-3 mb-3">
                            <div class="col-md-4">
                                <div class="p-3 rounded-3 bg-cream h-100 d-flex flex-column justify-content-between">
                                    <p class="matcha-body-s text-muted text-uppercase mb-1">Total Rent</p>
                                    <div class="matcha-amount text-charcoal">
                                        @Model.SelectedTenantSummary.TotalRent.ToString("C", pesoCulture)
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 rounded-3 bg-cream h-100 d-flex flex-column justify-content-between">
                                    <p class="matcha-body-s text-muted text-uppercase mb-1">Amount Paid</p>
                                    <div class="matcha-amount text-success">
                                        @Model.SelectedTenantSummary.AmountPaid.ToString("C", pesoCulture)
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="p-3 rounded-3 bg-cream h-100 d-flex flex-column justify-content-between">
                                    <p class="matcha-body-s text-muted text-uppercase mb-1">Remaining Balance</p>
                                    <div class="matcha-amount text-danger">
                                        @Model.SelectedTenantSummary.RemainingBalance.ToString("C", pesoCulture)
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="row g-3">
                            <div class="col-md-4">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-calendar-check text-primary" style="font-size: 1.4rem;"></i>
                                    <div>
                                        <p class="matcha-body-s text-muted mb-1">Last Settled Date</p>
                                        <p class="matcha-body-s mb-0">
                                            @(Model.SelectedTenantSummary.LastDateFullySettled?.ToString("MMM dd, yyyy") ?? "No payments yet")
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-credit-card text-primary" style="font-size: 1.4rem;"></i>
                                    <div>
                                        <p class="matcha-body-s text-muted mb-1">Latest Payment Method</p>
                                        <p class="matcha-body-s mb-0">
                                            @Model.SelectedTenantSummary.LatestPaymentMethod
                                        </p>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="d-flex align-items-center gap-2">
                                    <i class="bi bi-house-door text-primary" style="font-size: 1.4rem;"></i>
                                    <div>
                                        <p class="matcha-body-s text-muted mb-1">Unit Number</p>
                                        <p class="matcha-body-s mb-0">
                                            @Model.SelectedTenantSummary.UnitNumber
                                        </p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </article>
            </section>
        }

        <!-- Monthly Breakdown or Tenant List -->
        @if (Model.SelectedTenantUserId.HasValue)
        {
            <section class="matcha-section">
                <article class="matcha-card">
                    <div class="matcha-card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="matcha-card-title mb-1">
                                <i class="bi bi-calendar-month me-2"></i>Monthly Payment Breakdown
                            </h2>
                            <p class="matcha-body-s text-muted mb-0">
                                Track rent, payments, and remaining balance for each billing month.
                            </p>
                        </div>
                    </div>
                    <div class="matcha-card-body pt-0">
                        @if (Model.MonthlyBreakdowns.Any())
                        {
                            <div class="table-responsive mt-3">
                                <table class="table table-hover align-middle billing-table data-table" id="paymentsTable">
                                    <thead class="billing-table-head">
                                        <tr>
                                            <th>Month</th>
                                            <th class="text-end">Rent Amount</th>
                                            <th class="text-end">Paid Amount</th>
                                            <th class="text-end">Remaining</th>
                                            <th>Status</th>
                                            <th>Date Settled</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var breakdown in Model.MonthlyBreakdowns)
                                        {
                                            var statusClass = breakdown.Status switch
                                            {
                                                "Paid" => "matcha-status-chip success",
                                                "Unpaid" => "matcha-status-chip warning",
                                                _ => "matcha-status-chip neutral"
                                            };
                                            <tr>
                                                <td class="fw-medium">@breakdown.Month @breakdown.Year</td>
                                                <td class="text-end billing-table-money">
                                                    @breakdown.RentAmount.ToString("C", pesoCulture)
                                                </td>
                                                <td class="text-end billing-table-money text-success">
                                                    @breakdown.PaidAmount.ToString("C", pesoCulture)
                                                </td>
                                                <td class="text-end billing-table-money text-danger">
                                                    @breakdown.RemainingBalance.ToString("C", pesoCulture)
                                                </td>
                                                <td>
                                                    <span class="@statusClass">
                                                        <i class="bi bi-circle-fill me-1" style="font-size: 0.55rem;"></i>
                                                        @breakdown.Status
                                                    </span>
                                                </td>
                                                <td>
                                                    @(breakdown.DateFullySettled?.ToString("MMM dd, yyyy") ?? "—")
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-3 mb-0">No payment records found for the selected filters.</p>
                            </div>
                        }
                    </div>
                </article>
            </section>
        }
        else
        {
            <section class="matcha-section">
                <article class="matcha-card">
                    <div class="matcha-card-header d-flex justify-content-between align-items-center">
                        <div>
                            <h2 class="matcha-card-title mb-1">
                                <i class="bi bi-list-ul me-2"></i>Tenants (@Model.TenantSummaries.Count)
                            </h2>
                            <p class="matcha-body-s text-muted mb-0">
                                Overview of tenant balances and payment status.
                            </p>
                        </div>
                    </div>
                    <div class="matcha-card-body pt-0">
                        @if (Model.TenantSummaries.Any())
                        {
                            <div class="table-responsive mt-3">
                                <table class="table table-hover align-middle billing-table data-table" id="paymentsTable">
                                    <thead class="billing-table-head">
                                        <tr>
                                            <th>Tenant Name</th>
                                            <th>Unit</th>
                                            <th class="text-end">Monthly Rent</th>
                                            <th class="text-end">Total Paid</th>
                                            <th class="text-end">Remaining</th>
                                            <th>Status</th>
                                            <th>Last Settled</th>
                                            <th class="text-center">Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var summary in Model.TenantSummaries)
                                        {
                                            var statusClass = summary.PaymentStatus switch
                                            {
                                                "Paid" => "matcha-status-chip success",
                                                "Unpaid" => "matcha-status-chip danger",
                                                _ => "matcha-status-chip neutral"
                                            };
                                            <tr>
                                                <td class="fw-medium">@summary.TenantName</td>
                                                <td>
                                                    <span class="badge bg-primary">@summary.UnitNumber</span>
                                                </td>
                                                <td class="text-end billing-table-money">
                                                    @summary.MonthlyRent.ToString("C", pesoCulture)
                                                </td>
                                                <td class="text-end billing-table-money text-success">
                                                    @summary.TotalPaid.ToString("C", pesoCulture)
                                                </td>
                                                <td class="text-end billing-table-money text-danger">
                                                    @summary.RemainingBalance.ToString("C", pesoCulture)
                                                </td>
                                                <td>
                                                    <span class="@statusClass">
                                                        <i class="bi bi-circle-fill me-1" style="font-size: 0.55rem;"></i>
                                                        @summary.PaymentStatus
                                                    </span>
                                                </td>
                                                <td>
                                                    @(summary.LastDateFullySettled?.ToString("MMM dd, yyyy") ?? "—")
                                                </td>
                                                <td class="text-center">
                                                    <a asp-page="/Admin/RecordPayments"
                                                       asp-route-SelectedTenantUserId="@summary.TenantId"
                                                       class="matcha-btn-primary-light matcha-btn-compact">
                                                        <i class="bi bi-eye me-1"></i>View
                                                    </a>
                                                </td>
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>
                        }
                        else
                        {
                            <div class="text-center py-5">
                                <i class="bi bi-inbox text-muted" style="font-size: 3rem;"></i>
                                <p class="text-muted mt-3 mb-0">No tenants found matching your filters.</p>
                            </div>
                        }
                    </div>
                </article>
            </section>
        }
    </div>
</div>

<style>
    .billing-table {
        font-size: 0.9rem;
    }

    .billing-table-head {
        background-color: #4A6F47;
        color: #FFFFFF;
    }

    .billing-table-head th {
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        border-bottom: none;
        color: #FFFFFF !important;
    }

    .billing-table-head th a {
        color: #FFFFFF !important;
        text-decoration: none;
    }

    .billing-table tbody tr:nth-child(even) {
        background-color: #F9F8F3;
    }

    .billing-table tbody tr:nth-child(odd) {
        background-color: #FFFFFF;
    }

    .billing-table tbody tr:hover {
        background-color: #E3EDD9;
        transition: background-color 200ms ease-out;
    }

    .billing-table-money {
        font-family: "JetBrains Mono", Consolas, monospace;
    }

    .bg-cream {
        background-color: #FAF8F5;
    }

    .matcha-btn-primary-light {
        display: inline-flex;
        align-items: center;
        justify-content: center;
        padding: 10px 18px;
        border-radius: 8px;
        font-family: "Inter", "Nunito", Arial, sans-serif;
        font-size: 15px;
        font-weight: 500;
        background-color: #A8C3A0;
        color: #2C2C2C;
        border: 1px solid #4A6F47;
        transition: background-color 0.15s ease-out, color 0.15s ease-out, box-shadow 0.15s ease-out, border-color 0.15s ease-out;
    }

    .matcha-btn-primary-light:hover {
        background-color: #C3D5BA;
        color: #2C2C2C;
        border-color: #4A6F47;
        box-shadow: 0 0 0 2px rgba(168, 195, 160, 0.35);
        text-decoration: none;
    }
</style>
